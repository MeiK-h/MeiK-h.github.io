<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://meik2333.com/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://meik2333.com/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://meik2333.com/css/github.min.css' />
    <link rel="stylesheet" href='https://meik2333.com/css/github-style.css' />
    <link rel="stylesheet" href='https://meik2333.com/css/light.css' />
    <link rel="stylesheet" href='https://meik2333.com/css/dark.css' />
    <title>如何写一个爬虫 - 第三篇 - MeiK&#39;s blog</title>
    <link rel="icon" type="image/x-icon" href='https://meik2333.com/images/favicon.ico'>
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="从零开始实现一个爬虫。
" />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://meik2333.com/post/crawler3/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="如何写一个爬虫 - 第三篇 - MeiK&#39;s blog" />
<meta name="twitter:description"
  content="从零开始实现一个爬虫。
" />
<meta name="twitter:site" content="https://meik2333.com/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://meik2333.com/">


<meta property="og:type" content="article" />
<meta property="og:title" content="如何写一个爬虫 - 第三篇 - MeiK&#39;s blog">
<meta property="og:description"
  content="从零开始实现一个爬虫。
" />
<meta property="og:url" content="https://meik2333.com/post/crawler3/" />
<meta property="og:site_name" content="如何写一个爬虫 - 第三篇" />
<meta property="og:image"
  content="https://meik2333.com/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2019-08-16 14:00:57 &#43;0000 UTC" />










</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://meik2333.com/">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://meik2333.com/">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://meik2333.com/">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://meik2333.com/">
                  <img class=" avatar-user"
                    src="https://meik2333.com/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://meik2333.com/">MeiK</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://meik2333.com/post/crawler3/">如何写一个爬虫 - 第三篇</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Fri, 16 Aug 2019 14:00:57 &#43;0000"
                    class="no-wrap">
                    Fri, 16 Aug 2019 14:00:57 &#43;0000</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Fri, 11 Oct 2019 17:47:23 &#43;0800"
                    class="no-wrap">
                    Fri, 11 Oct 2019 17:47:23 &#43;0800</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div class="file-header d-flex flex-md-items-center flex-items-start">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    1659 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/%E7%88%AC%E8%99%AB">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      爬虫
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/python">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Python
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5">
                <article class="markdown-body entry-content container-lg"><p>从零开始实现一个爬虫。</p>

<blockquote>
<p>&ldquo;But man is not made for defeat,&rdquo; he said. &ldquo;A man can be destroyed but not defeated.&rdquo;
“不过我得记住一点，人不是为失败而生的，”他说，“一个人可以被毁灭，但不能给打败。”&mdash;&mdash;《老人与海》 - 海明威</p>
</blockquote>

<p>我们已经有了一个可用的爬虫框架——虽然它只有一个函数 <code>fetch</code>。它的用法并不够明确，且直接返回 HTTP 响应的所有内容未免过于简单粗暴，这对我们用户的使用带来了很多困扰。因此，我们还需要对其进行改造，使我们的爬虫框架更加清晰与易用。</p>

<h2 id="request-与-response">Request 与 Response</h2>

<p>如果你曾经用某种语言写过 Web 应用的话，那应该对 <code>Request</code> 和 <code>Response</code> 并不陌生。一般我们将用户发送给服务器的请求称为 <code>Request</code> ，而服务器对用户返回的响应即为 <code>Response</code> 。</p>

<p>我们也使用 <code>Request</code> 与 <code>Response</code> 对框架进行封装，用户需要构造一个 <code>Request</code>来发送请求，并获得一个 <code>Response</code> 的实例。</p>

<p><code>Request</code> 沿用之前 <code>fetch</code> 的参数，而对于 <code>Response</code> ，我们先简单的做一下响应的解析。因此，两个类的定义分别如下：</p>

<p><strong>models.py/Request</strong></p>

<pre><code class="language-python">class Request(object):
    def __init__(
        self,
        method: str = None,
        url: str = None,
        headers: dict = None,
        data: str = None,
        params: dict = None,
    ):
        data = &quot;&quot; if data is None else data
        headers = {} if headers is None else headers
        params = {} if params is None else params

        self.method = method
        self.url = url
        self.headers = headers
        self.data = data
        self.params = params
</code></pre>

<p><strong>models.py/Response</strong></p>

<pre><code class="language-python">class Response(object):
    def __init__(self, request, raw_content):
        self.raw_content = raw_content  # 原始的响应内容
        self.headers = {}  # 响应的 headers
        self.content = None  # 响应的正文内容
        self.status_code = None  # 响应的 HTTP 状态码
        self.request = request  # 对应的 Request
</code></pre>

<p><code>Request</code> 与 <code>Response</code> 分别对应请求与响应的内容，我们认为一次（或同一站点的多次）与网站的交互为一次会话，请求与响应通过会话联系起来。因此为了将两个类联系起来，我们引入一个新的类 <code>Session</code> 。一个 <code>Session</code> 可能关联多个 <code>Request</code> 与 <code>Response</code> 。</p>

<p><strong>sessions.py/Session</strong></p>

<pre><code class="language-python">class Session(object):
    def send(self, request: Request) -&gt; Response:
        # 利用 fetch 函数，发送 Request 并返回 Response
</code></pre>

<p>从这个版本开始，我们的代码量已经比较大了，因此在博客中将只介绍部分代码，具体代码需要读者去 <a href="https://github.com/MeiK2333/ZeroCrawler">GitHub</a> 上自行查看。我也推荐读者能自己敲一下完整的代码，从而对我们的爬虫框架有更深刻的理解。</p>

<p>实现了以上三个类的内容后，用户使用我们的框架的画风将是这样的：</p>

<pre><code class="language-python">&gt;&gt;&gt; from ZeroCrawler.models import Request, Response
&gt;&gt;&gt; from ZeroCrawler.sessions import Session
&gt;&gt;&gt; session = Session()  # 实例化 Session
&gt;&gt;&gt; req = Request(method='get', url='http://httpbin.org/get')  # 实例 Request
&gt;&gt;&gt; resp = session.send(req)  # 发起请求
&gt;&gt;&gt; print(resp)
&lt;Response [200]&gt;
&gt;&gt;&gt; resp.status_code
200
&gt;&gt;&gt; resp.headers
{'Access-Control-Allow-Credentials': 'true', 'Access-Control-Allow-Origin': '*', 'Content-Type': 'application/json', 'Date': 'Fri, 16 Aug 2019 07:40:38 GMT', 'Referrer-Policy': 'no-referrer-when-downgrade', 'Server': 'nginx', 'X-Content-Type-Options': 'nosniff', 'X-Frame-Options': 'DENY', 'X-XSS-Protection': '1; mode=block', 'Content-Length': '146', 'Connection': 'Close'}
&gt;&gt;&gt; resp.content
'{\n  &quot;args&quot;: {}, \n  &quot;headers&quot;: {\n    &quot;Host&quot;: &quot;httpbin.org&quot;\n  }, \n  &quot;origin&quot;: &quot;36.110.78.251, 36.110.78.251&quot;, \n  &quot;url&quot;: &quot;https://httpbin.org/get&quot;\n}\n'
</code></pre>

<p>除了 <code>Response</code> 已经帮我们把数据解析出来了以外，看起来好像并没有比以前简洁多少。别慌，让我们再加点东西。</p>

<h2 id="人类可用的-api">人类可用的 API</h2>

<blockquote>
<p><strong>警告</strong>：非专业使用其他 HTTP 库会导致危险的副作用，包括：安全缺陷症、冗余代码症、重新发明轮子症、啃文档症、抑郁、头疼、甚至死亡。&mdash;&mdash; <a href="https://2.python-requests.org//zh_CN/latest/">Requests</a></p>
</blockquote>

<p>首先我们为 <code>Session</code> 添加两个函数，让我们可以在 <code>Session</code> 中使用 <code>with</code> ：</p>

<pre><code class="language-python">class Session(object):
    def __enter__(self):
        return self

    def __exit__(self, *args):
        pass
</code></pre>

<p>这让我们可以这样使用：</p>

<pre><code class="language-python">with sessions.Session() as session:
    resp = session.send(req)
</code></pre>

<p>代码的缩进关系可以让我们更容易看出类之间的包含关系，当然这并不是我们修改的主要原因，下一章将具体介绍这段代码的作用，具体的优化在后面。</p>

<p>创建文件 <code>api.py</code> ，并写入如下内容：</p>

<pre><code class="language-python">from . import sessions

def request(method: str, url: str, **kwargs):
    with sessions.Session() as session:
        return session.request(method=method, url=url, **kwargs)
</code></pre>

<p>现在我们使用它的方法变成了这样：</p>

<pre><code class="language-python">&gt;&gt;&gt; from ZeroCrawler.api import request
&gt;&gt;&gt; resp = request('get', 'http://httpbin.org/get')
&gt;&gt;&gt; resp.status_code
200
</code></pre>

<p>是不是很简单？我们还能让它更简单一点。在上一章中我们介绍了 HTTP 的请求方法，目前共有九种，我们可以为这九种（其实是七种，因为有两种 <code>CONNECT</code> 和 <code>TRACE</code> 是用于 HTTP 调试的）来创建“快捷方式”：</p>

<p><strong>api.py</strong></p>

<pre><code class="language-python">def get(url: str, params: dict = None, **kwargs):
    return request(&quot;get&quot;, url, params=params, **kwargs)

def post(url: str, data: str = None, **kwargs):
    return request(&quot;post&quot;, url, data=data, **kwargs)

def options(url: str, **kwargs):  # ...
def head(url: str, **kwargs):  # ...
def put(url: str, data: str = None, **kwargs):  # ...
def patch(url: str, data: str = None, **kwargs):  # ...
def delete(url: str, **kwargs):  # ...
</code></pre>

<p>最终，我们的用法变成了这样：</p>

<pre><code class="language-python">&gt;&gt;&gt; from ZeroCrawler.api import get
&gt;&gt;&gt; resp = get('http://httpbin.org/get')
&gt;&gt;&gt; resp.status_code
200
</code></pre>

<p>简单明了，符合我们的期望。</p>

<h2 id="总结">总结</h2>

<p>如果你用过 Python 中的 <code>requests</code> 库的话，会发现我们的 API 与它的 API 极其相似——因为我是照着它的 API 来写的。</p>

<p>ZeroCrawler 的整个设计都是借鉴的早期版本的 <code>requests</code> ，我们就是在循序渐进的造一个迷你版的 <code>requests</code> 。同样是从基础开始学习，比起跟着质量良莠不齐的各种教程，我更希望读者能一开始就跟着业内最高质量的开源项目来学习。过程中可能有很多精华在我转换的过程中丢失了，如果有遗漏之处，请读者告知。</p>

<p>照例，本版本的项目源码在 GitHub 上：<a href="https://github.com/MeiK2333/ZeroCrawler/tree/46f8803797095db0ebaad12f44a5227b09f2de5a">ZeroCrawler Version 0.1.0</a> ，从这个版本开始，我们的 API 将基本定型，之后的更新也不会破坏之前的 API 。为了表示我们 API 已经稳定了，我们将版本从 0.0.2 直接提升到了 0.1.0 。</p>

<p>至此，我们的爬虫框架已经支持基础的爬虫功能了。但我们对 1.0 及之后的特性、 HTTP header 的具体行为还没有支持，之后的章节我们会依次介绍这些特性并支持它们，还请多多关注。</p></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://meik2333.com/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://meik2333.com/js/github-style.js"></script>



</html>