<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://meik2333.com/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://meik2333.com/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://meik2333.com/css/github.min.css' />
    <link rel="stylesheet" href='https://meik2333.com/css/github-style.css' />
    <link rel="stylesheet" href='https://meik2333.com/css/light.css' />
    <link rel="stylesheet" href='https://meik2333.com/css/dark.css' />
    <title>WebBench 源码分析 [不推荐阅读] - MeiK&#39;s blog</title>
    <link rel="icon" type="image/x-icon" href='https://meik2333.com/images/favicon.ico'>
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="在学习的过程中, 总是要阅读很多别人的代码的. 很多优秀的开源代码能够让我们受益匪浅, 也有一些代码, 看了之后只会让我们感觉浪费了时间&amp;hellip;&amp;hellip;
Webbench是Radim Kolar在1997年写的一个在linux下使用的非常简单的网站压测工具。它使用fork()模拟多个客户端同时访问我们设定的URL，测试网站在压力下工作的性能，最多可以模拟3万个并发连接去测试网站的负载能力。
" />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://meik2333.com/post/webbench-source-and-analysis/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="WebBench 源码分析 [不推荐阅读] - MeiK&#39;s blog" />
<meta name="twitter:description"
  content="在学习的过程中, 总是要阅读很多别人的代码的. 很多优秀的开源代码能够让我们受益匪浅, 也有一些代码, 看了之后只会让我们感觉浪费了时间&amp;hellip;&amp;hellip;
Webbench是Radim Kolar在1997年写的一个在linux下使用的非常简单的网站压测工具。它使用fork()模拟多个客户端同时访问我们设定的URL，测试网站在压力下工作的性能，最多可以模拟3万个并发连接去测试网站的负载能力。
" />
<meta name="twitter:site" content="https://meik2333.com/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://meik2333.com/">


<meta property="og:type" content="article" />
<meta property="og:title" content="WebBench 源码分析 [不推荐阅读] - MeiK&#39;s blog">
<meta property="og:description"
  content="在学习的过程中, 总是要阅读很多别人的代码的. 很多优秀的开源代码能够让我们受益匪浅, 也有一些代码, 看了之后只会让我们感觉浪费了时间&amp;hellip;&amp;hellip;
Webbench是Radim Kolar在1997年写的一个在linux下使用的非常简单的网站压测工具。它使用fork()模拟多个客户端同时访问我们设定的URL，测试网站在压力下工作的性能，最多可以模拟3万个并发连接去测试网站的负载能力。
" />
<meta property="og:url" content="https://meik2333.com/post/webbench-source-and-analysis/" />
<meta property="og:site_name" content="WebBench 源码分析 [不推荐阅读]" />
<meta property="og:image"
  content="https://meik2333.com/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2018-07-19 21:39:23 &#43;0000 UTC" />










</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://meik2333.com/">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://meik2333.com/">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://meik2333.com/">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://meik2333.com/">
                  <img class=" avatar-user"
                    src="https://meik2333.com/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://meik2333.com/">MeiK</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://meik2333.com/post/webbench-source-and-analysis/">WebBench 源码分析 [不推荐阅读]</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Thu, 19 Jul 2018 21:39:23 &#43;0000"
                    class="no-wrap">
                    Thu, 19 Jul 2018 21:39:23 &#43;0000</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Fri, 11 Oct 2019 17:03:20 &#43;0800"
                    class="no-wrap">
                    Fri, 11 Oct 2019 17:03:20 &#43;0800</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div class="file-header d-flex flex-md-items-center flex-items-start">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    3049 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/c-%E8%AF%AD%E8%A8%80">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      C 语言
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      网络编程
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5">
                <article class="markdown-body entry-content container-lg"><p>在学习的过程中, 总是要阅读很多别人的代码的. 很多优秀的开源代码能够让我们受益匪浅, 也有一些代码, 看了之后只会让我们感觉浪费了时间&hellip;&hellip;</p>

<p>Webbench是Radim Kolar在1997年写的一个在linux下使用的非常简单的网站压测工具。它使用fork()模拟多个客户端同时访问我们设定的URL，测试网站在压力下工作的性能，最多可以模拟3万个并发连接去测试网站的负载能力。</p>

<h2 id="问题">问题</h2>

<p>看完这个项目之后, 我注意到了这个项目的一些问题</p>

<ul>
<li>滥用全局变量</li>
<li>一个函数将一个全局变量作为函数参数传递给了另一个函数</li>
<li>代码风格不一致, 同样的功能(获取指定字符串位置)用了好几种不同的办法, 还混写在了一起</li>
<li><code>strcat(str1 + strlen(str1), str2)</code> 这种神奇的操作</li>
<li>可能会创建多个子进程(文档描述中说明可以上万个), 却只判断了最后一个是否成功</li>
<li>使用 <code>sleep</code> 来调度父子进程的先后关系</li>
<li>管道没有关闭不需要的一端</li>
<li>奇怪的变量复用, 比如在子进程中用 <code>pid</code> 又去表示了 <code>fscanf</code> 的返回值</li>
<li>&hellip;&hellip;</li>
</ul>

<h2 id="建议">建议</h2>

<p>不要看这个项目! 不要看这个项目! 不要看这个项目!</p>

<p>除非你想要从中获得什么反面的教学用例</p>

<p>如果你想要通过一个代码并不长、并不复杂的项目来学习一个 HTTP 服务相关的话, 那么我推荐 <a href="/2018/06/29/Tinyhttpd-源码及分析/">Tinyhttpd 源码及分析</a>. 虽然那个项目也有一些问题, 只能作为一个玩具使用, 但是对于学习来说是有一定意义的.</p>

<h2 id="源代码">源代码</h2>

<p>我居然用了一个多小时的时间看完了他的源代码并且加上了注释&hellip;&hellip;</p>

<h3 id="socket-c">socket.c</h3>

<pre><code class="language-C">/* $Id: socket.c 1.1 1995/01/01 07:11:14 cthuang Exp $
 *
 * This module has been modified by Radim Kolar for OS/2 emx
 */

/***********************************************************************
  module:       socket.c
  program:      popclient
  SCCS ID:      @(#)socket.c    1.5  4/1/94
  programmer:   Virginia Tech Computing Center
  compiler:     DEC RISC C compiler (Ultrix 4.1)
  environment:  DEC Ultrix 4.3
  description:  UNIX sockets code.
 ***********************************************************************/

#include &lt;arpa/inet.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;netdb.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;stdarg.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/time.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;

int Socket(const char *host, int clientPort) {
    int sock;
    unsigned long inaddr;
    struct sockaddr_in ad;
    struct hostent *hp;

    memset(&amp;ad, 0, sizeof(ad));
    ad.sin_family = AF_INET;

    /* 尝试以 IP 形式解析 */
    inaddr = inet_addr(host);
    if (inaddr != INADDR_NONE)
        memcpy(&amp;ad.sin_addr, &amp;inaddr, sizeof(inaddr));
    else { /* 如果解析失败, 则尝试通过 DNS 进行转换 */
        /* gethostbyname 是过时的函数, 应当使用 getaddrinfo 替换掉它 */
        hp = gethostbyname(host);
        if (hp == NULL) return -1;
        memcpy(&amp;ad.sin_addr, hp-&gt;h_addr, hp-&gt;h_length);
    }
    ad.sin_port = htons(clientPort);

    /* 创建 socket 连接 */
    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock &lt; 0) return sock;
    if (connect(sock, (struct sockaddr *)&amp;ad, sizeof(ad)) &lt; 0) return -1;
    return sock;
}

</code></pre>

<h3 id="webbench-c">webbench.c</h3>

<pre><code class="language-C">/*
 * (C) Radim Kolar 1997-2004
 * This is free software, see GNU Public License version 2 for
 * details.
 *
 * Simple forking WWW Server benchmark:
 *
 * Usage:
 *   webbench --help
 *
 * Return codes:
 *    0 - sucess
 *    1 - benchmark failed (server is not on-line)
 *    2 - bad param
 *    3 - internal error, fork failed
 *
 */

#include &lt;getopt.h&gt;
#include &lt;rpc/types.h&gt;
#include &lt;signal.h&gt;
#include &lt;strings.h&gt;
#include &lt;sys/param.h&gt;
#include &lt;time.h&gt;
#include &lt;unistd.h&gt;
#include &quot;socket.c&quot;

/* values */
volatile int timerexpired = 0;
int speed = 0;
int failed = 0;
int bytes = 0;

/* globals */
int http10 = 1; /* 0 - http/0.9, 1 - http/1.0, 2 - http/1.1 */
/* Allow: GET, HEAD, OPTIONS, TRACE */
#define METHOD_GET 0
#define METHOD_HEAD 1
#define METHOD_OPTIONS 2
#define METHOD_TRACE 3
#define PROGRAM_VERSION &quot;1.5&quot;
int method = METHOD_GET;
int clients = 1;
int force = 0;
int force_reload = 0;
int proxyport = 80;
char *proxyhost = NULL;
int benchtime = 30;

/* internal */
int mypipe[2];
char host[MAXHOSTNAMELEN];
#define REQUEST_SIZE 2048
char request[REQUEST_SIZE];

static const struct option long_options[] = {
    {&quot;force&quot;, no_argument, &amp;force, 1},
    {&quot;reload&quot;, no_argument, &amp;force_reload, 1},
    {&quot;time&quot;, required_argument, NULL, 't'},
    {&quot;help&quot;, no_argument, NULL, '?'},
    {&quot;http09&quot;, no_argument, NULL, '9'},
    {&quot;http10&quot;, no_argument, NULL, '1'},
    {&quot;http11&quot;, no_argument, NULL, '2'},
    /* 绑定命令行参数与变量 */
    {&quot;get&quot;, no_argument, &amp;method, METHOD_GET},
    {&quot;head&quot;, no_argument, &amp;method, METHOD_HEAD},
    {&quot;options&quot;, no_argument, &amp;method, METHOD_OPTIONS},
    {&quot;trace&quot;, no_argument, &amp;method, METHOD_TRACE},
    {&quot;version&quot;, no_argument, NULL, 'V'},
    {&quot;proxy&quot;, required_argument, NULL, 'p'},
    {&quot;clients&quot;, required_argument, NULL, 'c'},
    {NULL, 0, NULL, 0}};

/* prototypes */
static void benchcore(const char *host, const int port, const char *request);
static int bench(void);
static void build_request(const char *url);

static void alarm_handler(int signal) { timerexpired = 1; }

static void usage(void) {
    fprintf(
        stderr,
        &quot;webbench [option]... URL\n&quot;
        &quot;  -f|--force               Don't wait for reply from server.\n&quot;
        &quot;  -r|--reload              Send reload request - Pragma: no-cache.\n&quot;
        &quot;  -t|--time &lt;sec&gt;          Run benchmark for &lt;sec&gt; seconds. Default &quot;
        &quot;30.\n&quot;
        &quot;  -p|--proxy &lt;server:port&gt; Use proxy server for request.\n&quot;
        &quot;  -c|--clients &lt;n&gt;         Run &lt;n&gt; HTTP clients at once. Default &quot;
        &quot;one.\n&quot;
        &quot;  -9|--http09              Use HTTP/0.9 style requests.\n&quot;
        &quot;  -1|--http10              Use HTTP/1.0 protocol.\n&quot;
        &quot;  -2|--http11              Use HTTP/1.1 protocol.\n&quot;
        &quot;  --get                    Use GET request method.\n&quot;
        &quot;  --head                   Use HEAD request method.\n&quot;
        &quot;  --options                Use OPTIONS request method.\n&quot;
        &quot;  --trace                  Use TRACE request method.\n&quot;
        &quot;  -?|-h|--help             This information.\n&quot;
        &quot;  -V|--version             Display program version.\n&quot;);
}

int main(int argc, char *argv[]) {
    /* 读取命令行参数 */
    int opt = 0;
    int options_index = 0;
    char *tmp = NULL;

    if (argc == 1) {
        usage();
        return 2;
    }

    while ((opt = getopt_long(argc, argv, &quot;912Vfrt:p:c:?h&quot;, long_options,
                              &amp;options_index)) != EOF) {
        switch (opt) {
            case 0:
                break;
            case 'f':
                /* 设置 force 模式 */
                force = 1;
                break;
            case 'r':
                /* 设置 reload 模式 */
                force_reload = 1;
                break;
            case '9':
                /* HTTP/0.9 */
                http10 = 0;
                break;
            case '1':
                /* HTTP/1.0 */
                http10 = 1;
                break;
            case '2':
                /* HTTP/1.1 */
                http10 = 2;
                break;
            case 'V':
                /* 打印版本信息并退出 */
                printf(PROGRAM_VERSION &quot;\n&quot;);
                exit(0);
            case 't':
                /* 设置运行时间 */
                benchtime = atoi(optarg);
                break;
            case 'p':
                /* proxy server parsing server:port */
                /**
                 * 解析代理设置, 使用 &quot;:&quot; 分割代理字符串
                 * eg: -p 127.0.0.1:1080
                 * proxyhost(char *): &quot;127.0.0.1&quot;
                 * proxyport(int): 1080
                 * */
                tmp = strrchr(optarg, ':');
                proxyhost = optarg;
                if (tmp == NULL) {
                    break;
                }
                /* 判断是否提供 hostname */
                if (tmp == optarg) {
                    fprintf(stderr,
                            &quot;Error in option --proxy %s: Missing hostname.\n&quot;,
                            optarg);
                    return 2;
                }
                /* 判断是否提供 port */
                if (tmp == optarg + strlen(optarg) - 1) {
                    fprintf(
                        stderr,
                        &quot;Error in option --proxy %s Port number is missing.\n&quot;,
                        optarg);
                    return 2;
                }
                *tmp = '\0';
                proxyport = atoi(tmp + 1);
                break;
            case ':':
            case 'h':
            case '?':
                /* 打印帮助 */
                usage();
                return 2;
                break;
            case 'c':
                /* 设置客户端个数 */
                clients = atoi(optarg);
                break;
        }
    }

    /**
     * 当所有带选项的参数都已读取结束, optind
     * 应当指向第一个不包含选项的命令行参数 若 optind == argc,
     * 则代表没有不包含选项的命令行参数
     * */
    if (optind == argc) {
        fprintf(stderr, &quot;webbench: Missing URL!\n&quot;);
        usage();
        return 2;
    }

    /* 设置 clients 和 benchtime 的默认值 */
    if (clients == 0) clients = 1;
    if (benchtime == 0) benchtime = 30;

    /* Copyright */
    /* 打印 Copyright */
    fprintf(stderr,
            &quot;Webbench - Simple Web Benchmark &quot; PROGRAM_VERSION
            &quot;\n&quot;
            &quot;Copyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n&quot;);

    build_request(argv[optind]);

    // print request info ,do it in function build_request
    /*printf(&quot;Benchmarking: &quot;);

    switch(method)
    {
        case METHOD_GET:
        default:
        printf(&quot;GET&quot;);break;
        case METHOD_OPTIONS:
        printf(&quot;OPTIONS&quot;);break;
        case METHOD_HEAD:
        printf(&quot;HEAD&quot;);break;
        case METHOD_TRACE:
        printf(&quot;TRACE&quot;);break;
    }

    printf(&quot; %s&quot;,argv[optind]);

    switch(http10)
    {
        case 0: printf(&quot; (using HTTP/0.9)&quot;);break;
        case 2: printf(&quot; (using HTTP/1.1)&quot;);break;
    }

    printf(&quot;\n&quot;);
    */

    /* 打印配置 */
    printf(&quot;Runing info: &quot;);

    if (clients == 1)
        printf(&quot;1 client&quot;);
    else
        printf(&quot;%d clients&quot;, clients);

    printf(&quot;, running %d sec&quot;, benchtime);

    if (force) printf(&quot;, early socket close&quot;);
    if (proxyhost != NULL)
        printf(&quot;, via proxy server %s:%d&quot;, proxyhost, proxyport);
    if (force_reload) printf(&quot;, forcing reload&quot;);

    printf(&quot;.\n&quot;);

    /* 开始执行 */
    return bench();
}

void build_request(const char *url) {
    char tmp[10];
    int i;

    // bzero(host,MAXHOSTNAMELEN);
    // bzero(request,REQUEST_SIZE);
    memset(host, 0, MAXHOSTNAMELEN);
    memset(request, 0, REQUEST_SIZE);

    /* 根据 reload 和 method 等参数调整 HTTP */
    if (force_reload &amp;&amp; proxyhost != NULL &amp;&amp; http10 &lt; 1) http10 = 1;
    if (method == METHOD_HEAD &amp;&amp; http10 &lt; 1) http10 = 1;
    if (method == METHOD_OPTIONS &amp;&amp; http10 &lt; 2) http10 = 2;
    if (method == METHOD_TRACE &amp;&amp; http10 &lt; 2) http10 = 2;

    switch (method) {
        default:
        case METHOD_GET:
            strcpy(request, &quot;GET&quot;);
            break;
        case METHOD_HEAD:
            strcpy(request, &quot;HEAD&quot;);
            break;
        case METHOD_OPTIONS:
            strcpy(request, &quot;OPTIONS&quot;);
            break;
        case METHOD_TRACE:
            strcpy(request, &quot;TRACE&quot;);
            break;
    }

    strcat(request, &quot; &quot;);

    /* 检查 URL 是否合法 */
    if (NULL == strstr(url, &quot;://&quot;)) {
        fprintf(stderr, &quot;\n%s: is not a valid URL.\n&quot;, url);
        exit(2);
    }
    /* 检查 URL 长度 */
    if (strlen(url) &gt; 1500) {
        fprintf(stderr, &quot;URL is too long.\n&quot;);
        exit(2);
    }
    /* 忽略大小写对比两个字符串的前 n 个字符 */
    /* 仅支持 HTTP 协议 */
    if (0 != strncasecmp(&quot;http://&quot;, url, 7)) {
        fprintf(stderr,
                &quot;\nOnly HTTP protocol is directly supported, set --proxy for &quot;
                &quot;others.\n&quot;);
        exit(2);
    }

    /* protocol/host delimiter */
    /* 获得去掉协议后的 URL */
    i = strstr(url, &quot;://&quot;) - url + 3;

    /* 判断 '/' 是否在 URL 中出现过 */
    if (strchr(url + i, '/') == NULL) {
        fprintf(stderr,
                &quot;\nInvalid URL syntax - hostname don't ends with '/'.\n&quot;);
        exit(2);
    }

    /* url + i 指向 URL 去掉协议后的开头 */
    if (proxyhost == NULL) {
        /* get port from hostname */
        /**
         * 如果没有使用代理, 则解析 URL 到 host 和 proxyport
         * eg: http://127.0.0.1:8080/
         * host(char *): 127.0.0.1
         * proxyport(int): 8080
         * */
        if (index(url + i, ':') != NULL &amp;&amp;
            index(url + i, ':') &lt; index(url + i, '/')) { /* 如果指定了端口 */
            strncpy(host, url + i, strchr(url + i, ':') - url - i);
            // bzero(tmp,10);
            memset(tmp, 0, 10);
            strncpy(tmp, index(url + i, ':') + 1,
                    strchr(url + i, '/') - index(url + i, ':') - 1);
            /* printf(&quot;tmp=%s\n&quot;,tmp); */
            proxyport = atoi(tmp);
            if (proxyport == 0) proxyport = 80;
        } else { /* 没有指定端口 */
            strncpy(host, url + i, strcspn(url + i, &quot;/&quot;));
        }
        // printf(&quot;Host=%s\n&quot;,host);
        /**
         * 这个 request + strlen(request) 我实在是没看懂
         * strlen 获得 request 后第一个 '\0' 的位置
         * strcat 替换 request 后第一个 '\0' 并追加字符串, 在末尾添加 '\0'
         * 那为什么要先找到 '\0' 的位置再去 strcat......
         * */
        strcat(request + strlen(request), url + i + strcspn(url + i, &quot;/&quot;));
    } else {
        // printf(&quot;ProxyHost=%s\nProxyPort=%d\n&quot;,proxyhost,proxyport);
        strcat(request, url);
    }

    /* 拼接 HTTP 协议 */
    if (http10 == 1)
        strcat(request, &quot; HTTP/1.0&quot;);
    else if (http10 == 2)
        strcat(request, &quot; HTTP/1.1&quot;);

    strcat(request, &quot;\r\n&quot;);

    /* 拼接 UA */
    if (http10 &gt; 0)
        strcat(request, &quot;User-Agent: WebBench &quot; PROGRAM_VERSION &quot;\r\n&quot;);
    /* 拼接 Host */
    if (proxyhost == NULL &amp;&amp; http10 &gt; 0) {
        strcat(request, &quot;Host: &quot;);
        strcat(request, host);
        strcat(request, &quot;\r\n&quot;);
    }

    /* 拼接其余字段 */
    if (force_reload &amp;&amp; proxyhost != NULL) {
        strcat(request, &quot;Pragma: no-cache\r\n&quot;);
    }

    if (http10 &gt; 1) strcat(request, &quot;Connection: close\r\n&quot;);

    /* add empty line at end */
    if (http10 &gt; 0) strcat(request, &quot;\r\n&quot;);

    printf(&quot;\nRequest:\n%s\n&quot;, request);
}

/* vraci system rc error kod */
static int bench(void) {
    int i, j, k;
    pid_t pid = 0;
    FILE *f;

    /* check avaibility of target server */
    i = Socket(proxyhost == NULL ? host : proxyhost, proxyport);
    if (i &lt; 0) {
        fprintf(stderr, &quot;\nConnect to server failed. Aborting benchmark.\n&quot;);
        return 1;
    }
    close(i);

    /* create pipe */
    /* 创建管道 */
    if (pipe(mypipe)) {
        perror(&quot;pipe failed.&quot;);
        return 3;
    }

    /* not needed, since we have alarm() in childrens */
    /* wait 4 next system clock tick */
    /*
    cas=time(NULL);
    while(time(NULL)==cas)
    sched_yield();
    */

    /* fork childs */
    /* 创建处理子进程 */
    for (i = 0; i &lt; clients; i++) {
        pid = fork();
        /* 不推荐将 fork 成功和失败的情况放在一起处理 */
        if (pid &lt;= (pid_t)0) {
            /* child process or error*/
            /* 你不能确定进程将于何时中断 */
            /* 因此这种方法并不推荐使用 */
            sleep(1); /* make childs faster */
            break;
        }
    }

    /* 这是? 创建了多个子进程, 然后判断最后一个 fork 是否成功? */
    if (pid &lt; (pid_t)0) {
        fprintf(stderr, &quot;problems forking worker no. %d\n&quot;, i);
        perror(&quot;fork failed.&quot;);
        return 3;
    }

    if (pid == (pid_t)0) {
        /* I am a child */
        /* 开始发送请求 */
        /* 取全局变量中的 request 作为参数传给本文件内的另一个函数 */
        /* 什么写法...... */
        if (proxyhost == NULL)
            benchcore(host, proxyport, request);
        else
            benchcore(proxyhost, proxyport, request);

        /* write results to pipe */
        /* 将结果写入 pipe */
        /* 此处没有关闭 mypipe[0] */
        /* 不知是何用意 */
        f = fdopen(mypipe[1], &quot;w&quot;);
        if (f == NULL) {
            perror(&quot;open pipe for writing failed.&quot;);
            return 3;
        }
        /* fprintf(stderr,&quot;Child - %d %d\n&quot;,speed,failed); */
        fprintf(f, &quot;%d %d %d\n&quot;, speed, failed, bytes);
        fclose(f);

        return 0;
    } else {
        /* 同样的, 此处没有关闭 mypipe[1] */
        f = fdopen(mypipe[0], &quot;r&quot;);
        if (f == NULL) {
            perror(&quot;open pipe for reading failed.&quot;);
            return 3;
        }

        /* 设置无缓冲 */
        setvbuf(f, NULL, _IONBF, 0);

        speed = 0;
        failed = 0;
        bytes = 0;

        while (1) {
            pid = fscanf(f, &quot;%d %d %d&quot;, &amp;i, &amp;j, &amp;k);
            if (pid &lt; 2) {
                fprintf(stderr, &quot;Some of our childrens died.\n&quot;);
                break;
            }

            speed += i;
            failed += j;
            bytes += k;

            /* fprintf(stderr,&quot;*Knock* %d %d read=%d\n&quot;,speed,failed,pid); */
            if (--clients == 0) break;
        }

        fclose(f);

        printf(
            &quot;\nSpeed=%d pages/min, %d bytes/sec.\nRequests: %d susceed, %d &quot;
            &quot;failed.\n&quot;,
            (int)((speed + failed) / (benchtime / 60.0f)),
            (int)(bytes / (float)benchtime), speed, failed);
    }

    return i;
}

void benchcore(const char *host, const int port, const char *req) {
    int rlen;
    char buf[1500];
    int s, i;
    struct sigaction sa;

    /* setup alarm signal handler */
    /* 设置 SIGALRM 信号的处理程序 */
    sa.sa_handler = alarm_handler;
    sa.sa_flags = 0;
    if (sigaction(SIGALRM, &amp;sa, NULL)) exit(3);

    /* 设置定时器, 超时产生 SIGALRM 信号 */
    alarm(benchtime);  // after benchtime,then exit

    rlen = strlen(req);
nexttry:
    while (1) {
        /**
         * 一直重试(重新发送一遍)
         * 直到超时
         * 如果超时的话, 把 failed--(是说被计时器中断的那个不算错误吗?)
         * */
        if (timerexpired) {
            if (failed &gt; 0) {
                /* fprintf(stderr,&quot;Correcting failed by signal\n&quot;); */
                failed--;
            }
            return;
        }

        s = Socket(host, port);
        if (s &lt; 0) {
            failed++;
            continue;
        }
        if (rlen != write(s, req, rlen)) {
            failed++;
            close(s);
            continue;
        }
        if (http10 == 0)
            if (shutdown(s, 1)) {
                failed++;
                close(s);
                continue;
            }
        if (force == 0) {
            /* read all available data from socket */
            /* 读取服务器响应 */
            while (1) {
                if (timerexpired) break;
                i = read(s, buf, 1500);
                /* fprintf(stderr,&quot;%d\n&quot;,i); */
                if (i &lt; 0) {
                    failed++;
                    close(s);
                    goto nexttry;
                } else if (i == 0)
                    break;
                else
                    bytes += i;
            }
        }
        if (close(s)) {
            failed++;
            continue;
        }
        speed++;
    }
}

</code></pre></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://meik2333.com/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://meik2333.com/js/github-style.js"></script>



</html>