<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  
  <meta name="generator" content="Hugo 0.58.3" />

  <title>Linux 中多个进程操作同一个文件时会发生什么 &middot; MeiK&#39;s blog</title>

  <link rel="shortcut icon" href="https://meik2333.com/images/favicon.ico">
  <link rel="stylesheet" href="https://meik2333.com/css/spectre.min.css">
  <link rel="stylesheet" href="https://meik2333.com/css/style.css">
  <link rel="stylesheet" href="https://meik2333.com/css/highlight.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css">
  

  

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-107784973-4', 'auto');
	
	ga('send', 'pageview');
}
</script>

  <meta property="og:title" content="Linux 中多个进程操作同一个文件时会发生什么" />
<meta property="og:description" content="与 Windows 不同， Linux 允许一个文件在写入的时候被读取（或者在被读取的时候写入），本文就来探索一下多个进程同时读写同一个文件会产生的效果。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://meik2333.com/posts/linux-many-proc-write-file/" />
<meta property="article:published_time" content="2019-03-27T14:24:23+00:00" />
<meta property="article:modified_time" content="2019-03-27T14:24:23+00:00" />

  
  <meta itemprop="name" content="Linux 中多个进程操作同一个文件时会发生什么">
<meta itemprop="description" content="与 Windows 不同， Linux 允许一个文件在写入的时候被读取（或者在被读取的时候写入），本文就来探索一下多个进程同时读写同一个文件会产生的效果。">


<meta itemprop="datePublished" content="2019-03-27T14:24:23&#43;00:00" />
<meta itemprop="dateModified" content="2019-03-27T14:24:23&#43;00:00" />
<meta itemprop="wordCount" content="396">



<meta itemprop="keywords" content="Go,Linux," />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linux 中多个进程操作同一个文件时会发生什么"/>
<meta name="twitter:description" content="与 Windows 不同， Linux 允许一个文件在写入的时候被读取（或者在被读取的时候写入），本文就来探索一下多个进程同时读写同一个文件会产生的效果。"/>

</head>

<body onload="setPixelFont()">
  <div class="container p-fixed" style="z-index:3">
  <nav class="navbar m-2 p-2 s-rounded shadow bg-primary">
    <section class="navbar-section">
      <button class="btn btn-action btn-primary s-circle text-gray" id="pixelfont-toggle"><i class="fas fa-robot fa-lg"></i></button>
    </section>
    <section class="navbar-section">
      
        <a class="btn btn-primary" href='https://meik2333.com'>Home</a>
      

      

      
    </section>
  </nav>
</div>

  <section class="container grid-md">
  <div class="columns">
    
    
<article class="container p-centered mt-space">
  <header>
    <h2 class="text-center">Linux 中多个进程操作同一个文件时会发生什么</h2>
    <h6 class="text-gray text-italic"></h6>
  </header>
  <section class="my-gap">
    <p><a href="https://softwareengineering.stackexchange.com/questions/288025/reading-file-during-write-on-linux">与 Windows 不同</a>， Linux 允许一个文件在写入的时候被读取（或者在被读取的时候写入），本文就来探索一下多个进程同时读写同一个文件会产生的效果。</p>

<h2 id="read-read">Read + Read</h2>

<p>多个进程同时读取同一个文件不会出现问题的，放心去干吧。</p>

<h2 id="read-write">Read + Write</h2>

<p>本文的重点研究对象。Linux 通过文件描述符表维护了打开的文件描述符信息，而文件描述符表中的每一项都指向一个内核维护的文件表，文件表指向打开的文件的 <a href="https://www.freebsd.org/cgi/man.cgi?query=vnode">vnode</a>(Unix) 和 <a href="https://en.wikipedia.org/wiki/Inode">inode</a>。同时，文件表保存了进程对文件读写的偏移量等信息。</p>

<p>我们通过两个简单的 Go 语言程序来测试一下在读文件的同时修改文件会发生什么：</p>

<p><strong>testwrite.go</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">writeFile</span>(<span style="color:#a6e22e">filename</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">data</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#a6e22e">filename</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_WRONLY</span>, <span style="color:#ae81ff">0644</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#a6e22e">body</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#a6e22e">data</span>)
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">body</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">// 首先向文件中写入 “Hello World!”
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">writeFile</span>(<span style="color:#e6db74">&#34;test.txt&#34;</span>, <span style="color:#e6db74">&#34;Hello World!&#34;</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">7</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">// 七秒后，修改文件内容，写入 “Author MeiK!”
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">writeFile</span>(<span style="color:#e6db74">&#34;test.txt&#34;</span>, <span style="color:#e6db74">&#34;Author MeiK!&#34;</span>)
}</code></pre></div>
<p><strong>testread.go</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">readFile</span>(<span style="color:#a6e22e">filename</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#a6e22e">filename</span>, <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">O_RDONLY</span>, <span style="color:#ae81ff">0644</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#a6e22e">body</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">1</span>)
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
		<span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">body</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> {
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Seek</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">SEEK_CUR</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%c %d\n&#34;</span>, <span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">s</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">readFile</span>(<span style="color:#e6db74">&#34;test.txt&#34;</span>)
}</code></pre></div>
<p>同时执行两个程序：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">./testwrite &amp; ./testread</code></pre></div>
<p>输出：</p>

<pre><code>[H] 1
[e] 2
[l] 3
[l] 4
[o] 5
[ ] 6
[ ] 7
[M] 8
[e] 9
[i] 10
[K] 11
[!] 12
</code></pre>

<p>这个程序打印了读取到的内容以及读取到每一步的文件偏移量。我们首先写入 <code>Hello World!</code>，开始每秒读取一个字符，并且在 7 秒后重新将 <code>Author MeiK!</code> 写入文件。我们最终读取到了什么呢？既不是 <code>Hello World!</code>，也不是 <code>Author MeiK!</code>，而是 <code>Hello  MeiK!</code>。我们每个字符串读取到了一半！</p>

<p>从每一步的文件偏移量来看，读取的程序只是按部就班的一个字符一个字符的读取文件，对文件内容的变化毫无感知，当读取到文件结尾的 <code>EOF</code> 时结束读取。</p>

<p>那么我们要如何保证读取与写入的一致性呢？ Linux 提供了 <code>fcntl</code> 系统调用，可以<a href="https://www.gnu.org/software/libc/manual/html_node/File-Locks.html">锁定文件</a>。</p>

<p>我们对刚刚的文件稍作修改，使用 <code>fcntl</code> 进行加锁：</p>

<p><strong>testwrite.go</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">writeFile</span>(<span style="color:#a6e22e">filename</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">data</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;write start&#34;</span>)
	<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#a6e22e">filename</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_WRONLY</span>, <span style="color:#ae81ff">0644</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#a6e22e">flockT</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">Flock_t</span>{
		<span style="color:#a6e22e">Type</span>:   <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">F_WRLCK</span>,
		<span style="color:#a6e22e">Whence</span>: <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">SeekStart</span>,
		<span style="color:#a6e22e">Start</span>:  <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">Len</span>:    <span style="color:#ae81ff">0</span>,
	}
	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">FcntlFlock</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Fd</span>(), <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">F_SETLKW</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">flockT</span>)

	<span style="color:#a6e22e">body</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#a6e22e">data</span>)
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">body</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;write end&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">// 首先向文件中写入 “Hello World!”
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">writeFile</span>(<span style="color:#e6db74">&#34;test.txt&#34;</span>, <span style="color:#e6db74">&#34;Hello World!&#34;</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">7</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">// 七秒后，修改文件内容，写入 “Author MeiK!”
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">writeFile</span>(<span style="color:#e6db74">&#34;test.txt&#34;</span>, <span style="color:#e6db74">&#34;Author MeiK!&#34;</span>)
}</code></pre></div>
<p><strong>testread.go</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">readFile</span>(<span style="color:#a6e22e">filename</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#a6e22e">filename</span>, <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">O_RDONLY</span>, <span style="color:#ae81ff">0644</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#a6e22e">flockT</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">Flock_t</span>{
		<span style="color:#a6e22e">Type</span>:   <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">F_RDLCK</span>,
		<span style="color:#a6e22e">Whence</span>: <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">SeekStart</span>,
		<span style="color:#a6e22e">Start</span>:  <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">Len</span>:    <span style="color:#ae81ff">0</span>,
	}
	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">FcntlFlock</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Fd</span>(), <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">F_SETLKW</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">flockT</span>)

	<span style="color:#a6e22e">body</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">1</span>)
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
		<span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">body</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> {
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Seek</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">SEEK_CUR</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%c %d\n&#34;</span>, <span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">s</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">readFile</span>(<span style="color:#e6db74">&#34;test.txt&#34;</span>)
}</code></pre></div>
<p>额外添加 <code>write start</code> 和 <code>write end</code> 来标识当前进度，执行结果如下：</p>

<pre><code>write start
write end
[H] 1
[e] 2
[l] 3
[l] 4
[o] 5
[ ] 6
write start
[W] 7
[o] 8
[r] 9
[l] 10
[d] 11
[!] 12
write end
</code></pre>

<p>可以看到，第一次写入文件时，进程很快的完成了写入；而当第二次写入时，由于此时 <code>read</code> 进程对文件加锁了，导致写入进程阻塞，直到读取结束后， <code>write</code> 进程才把内容写入了文件。因此 <code>read</code> 进程读取到的就是第一次写入的内容 <code>Hello World!</code>。完美的解决了我们的问题，可喜可贺。</p>

<p>不过，还有两点需要注意：</p>

<ol>
<li>文件锁是与进程相关的，一个进程中的多个线程/协程对同一个文件进行的锁操作会互相覆盖掉，从而无效。</li>
<li><code>fcntl</code> 创建的锁是建议性锁，只有写入的进程和读取的进程都遵循建议才有效；对应的有强制性锁，会在每次文件操作时进行判断，但性能较差，因此 Linux/Unix 系统默认采用的是建议性锁。</li>
</ol>

<p>关于不同类型锁之间的交互，可以参照此表：</p>

<table>
<thead>
<tr>
<th>当前状态</th>
<th>加读锁</th>
<th>加写锁</th>
</tr>
</thead>

<tbody>
<tr>
<td>无锁</td>
<td>允许</td>
<td>允许</td>
</tr>

<tr>
<td>一个或多个读锁</td>
<td>允许</td>
<td>拒绝</td>
</tr>

<tr>
<td>一个写锁</td>
<td>拒绝</td>
<td>拒绝</td>
</tr>
</tbody>
</table>

<h2 id="write-write">Write + Write</h2>

<p>两个进程同时写入可以和 <code>Write + Read</code> 一样靠加锁来解决同步问题，不过还有其他的解决方案：假如我们现在有多个进程在将日志写入同一个日志文件，那么我们可以使用 <code>O_APPEND</code> 标志来打开文件，这样在每次写入时都会 <code>lseek</code> 到文件末尾进行写入，这是一个原子操作，因此不会产生同步问题。</p>

<h2 id="结论">结论</h2>

<p>如果一个文件在读取的同时被修改（而没有添加任何锁机制的话），那么将可能会读到错误的数据，很多时候这比读不到数据或读到旧版本的数据的后果更加可怕……因此，如果有准确性要求较高的文件读取的情景的话，最好还是用强制性锁对文件进行保护。</p>

    
      <code class="text-bold">Tags</code> 
      
        <a class="chip text-accent" href="https://meik2333.com/tags/go">Go</a>
      
        <a class="chip text-accent" href="https://meik2333.com/tags/linux">Linux</a>
      
    
  </section>
  <div class="divider my-gap"></div>
  <footer class="col-12 d-inline-block">
    <span class="float-left">
      <button class="btn btn-action btn-accent shadow s-circle" onclick="window.history.back();"><i class="fas fa-arrow-left"></i></button>
    </span>
    <span class="float-right">
      <div class="text-right float-left mx-2">
        <span class="text-dark"></span><br>
        <span class="text-gray"></span>
      </div>
      <figure class="avatar avatar-lg">
        <img id="profile">
      </figure>
    </span>
  </footer>
</article>

    <footer class="container p-centered text-center my-gap">
  

  <small class="text-gray">
  
    © Copyright 2019 
  
  </small>
</footer>

  </div>
  </section>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://meik2333.com/js/main.js"></script>
<script src="https://meik2333.com/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-107784973-4', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
</html>
