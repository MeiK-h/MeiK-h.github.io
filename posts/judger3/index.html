<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  
  <meta name="generator" content="Hugo 0.58.3" />

  <title>如何写一个评测姬 - 第三篇 &middot; MeiK&#39;s blog</title>

  <link rel="shortcut icon" href="https://meik2333.com/images/favicon.ico">
  <link rel="stylesheet" href="https://meik2333.com/css/spectre.min.css">
  <link rel="stylesheet" href="https://meik2333.com/css/style.css">
  <link rel="stylesheet" href="https://meik2333.com/css/highlight.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css">
  

  

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-107784973-4', 'auto');
	
	ga('send', 'pageview');
}
</script>

  <meta property="og:title" content="如何写一个评测姬 - 第三篇" />
<meta property="og:description" content="从零开始实现一个 OJ 评测姬。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://meik2333.com/posts/judger3/" />
<meta property="article:published_time" content="2019-05-05T15:22:54+00:00" />
<meta property="article:modified_time" content="2019-05-05T15:22:54+00:00" />

  
  <meta itemprop="name" content="如何写一个评测姬 - 第三篇">
<meta itemprop="description" content="从零开始实现一个 OJ 评测姬。">


<meta itemprop="datePublished" content="2019-05-05T15:22:54&#43;00:00" />
<meta itemprop="dateModified" content="2019-05-05T15:22:54&#43;00:00" />
<meta itemprop="wordCount" content="188">



<meta itemprop="keywords" content="OnlineJudge,评测姬," />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="如何写一个评测姬 - 第三篇"/>
<meta name="twitter:description" content="从零开始实现一个 OJ 评测姬。"/>

</head>

<body onload="setPixelFont()">
  <div class="container p-fixed" style="z-index:3">
  <nav class="navbar m-2 p-2 s-rounded shadow bg-primary">
    <section class="navbar-section">
      <button class="btn btn-action btn-primary s-circle text-gray" id="pixelfont-toggle"><i class="fas fa-robot fa-lg"></i></button>
    </section>
    <section class="navbar-section">
      
        <a class="btn btn-primary" href='https://meik2333.com'>Home</a>
      

      

      
    </section>
  </nav>
</div>

  <section class="container grid-md">
  <div class="columns">
    
    
<article class="container p-centered mt-space">
  <header>
    <h2 class="text-center">如何写一个评测姬 - 第三篇</h2>
    <h6 class="text-gray text-italic"></h6>
  </header>
  <section class="my-gap">
    <p>从零开始实现一个 OJ 评测姬。</p>

<p>这一篇我们讲一下如何执行一个程序、重定向其输入输出。并实现一个最简单的评测姬。</p>

<h2 id="执行一个新的进程">执行一个新的进程</h2>

<p>Linux 下可以使用 <a href="http://man7.org/linux/man-pages/man3/system.3.html"><code>system</code></a> 函数来运行一个进程，用法如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    system(<span style="color:#e6db74">&#34;echo Hello World&#34;</span>);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}</code></pre></div>
<p>但 <code>system</code> 并不能满足我们的需求，我们需要在进程运行前进行一些自定义的操作，比如重定向流等。因此我们使用层级更低的 <code>fork</code> 来创建一个新的进程，使用 <code>exec</code> 函数来执行我们指定的进程（<code>system</code> 的实现也是 <code>fork</code> + <code>execl</code>）。在 <code>fork</code> 之后重定向流，然后 <code>exec</code> 来执行用户提交的程序，就可以实现我们的需求了。</p>

<p>使用 <code>fork</code> + <code>exec</code> 来改写上面的程序，就是这样：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#66d9ef">int</span> pid <span style="color:#f92672">=</span> fork();
    <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#75715e">// 重定向流或其他操作
</span><span style="color:#75715e"></span>        execl(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;echo Hello World&#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) NULL);
    }
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}</code></pre></div>
<p>虽然代码量比之前要多，但是我们可以在执行用户程序之前进行自定义的操作。同理，虽然<a href="https://www.microsoft.com/en-us/research/publication/a-fork-in-the-road/">有研究证明</a> 使用 <code>fork</code> + <code>exec</code> 来执行新的进程的性能远低于 <code>posix_spawn</code>，但是我们还是只能选择这个方案。</p>

<h2 id="重定向流">重定向流</h2>

<p>使用过 Linux 的同学可能对命令行重定向输入输出已经很熟悉了，<code>bash</code> 使用大于和小于的符号来表示流的重定向：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo Hello World &gt; hello.txt
$ cat hello.txt
Hello World</code></pre></div>
<p>其中的 <code>&gt;</code> 的用处就是将程序的标准输出重定向到文件中，本来应该被打印在终端上的内容被写入了文件。同理，<code>&lt;</code> 的作用是可以使用文件内的内容替代标准输入来传给程序。</p>

<p>这样做有什么意义呢？因为我们的题目数据都是文件形式，我们的答案对比函数也是基于文件的。有一些 OJ 是要求用户自行从文件中读取输入数据，并将答案写入到文件的，但大部分 OJ 都允许用户提交直接读标准输出 <code>stdin</code>、直接写标准输出 <code>stdout</code> 的代码。因此，从标准流到文件的转换就需要我们来进行处理。</p>

<p>Linux 可以使用 <a href="http://man7.org/linux/man-pages/man2/dup2.2.html"><code>dup2</code></a> 函数来重定向流，使得文件流连接标准流，这样进程就可以直接从标准输入输出流中读取写入文件了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    FILE <span style="color:#f92672">*</span>out_file <span style="color:#f92672">=</span> fopen(<span style="color:#e6db74">&#34;output.txt&#34;</span>, <span style="color:#e6db74">&#34;w&#34;</span>);
    dup2(fileno(out_file), STDOUT_FILENO);
    printf(<span style="color:#e6db74">&#34;Hello World&#34;</span>);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}</code></pre></div>
<p>执行代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./a.out
$ cat output.txt 
Hello World</code></pre></div>
<p>可以看到，<code>printf</code> 并没有把 <code>Hello World</code> 打印到屏幕上，而是将其写入了文件。</p>

<h2 id="结合">结合</h2>

<p>运行新的进程和重定向流的方法都有了，我们可以尝试结合一下这两者。为了方便起见，这里我们先不考虑编译的问题，直接使用 <code>system</code> 函数。结合完成的代码大概长这样：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">BaseRun</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>code_file_name, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>input_file_name) {
    <span style="color:#66d9ef">char</span> cmd[<span style="color:#ae81ff">1024</span>];
    strcpy(cmd, <span style="color:#e6db74">&#34;gcc &#34;</span>);
    strcpy(cmd <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>, code_file_name);
    system(cmd);
    <span style="color:#66d9ef">int</span> pid <span style="color:#f92672">=</span> fork();
    <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
        FILE <span style="color:#f92672">*</span>input_file <span style="color:#f92672">=</span> fopen(input_file_name, <span style="color:#e6db74">&#34;r&#34;</span>);
        dup2(fileno(input_file), STDIN_FILENO);
        execl(<span style="color:#e6db74">&#34;a.out&#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) NULL);
    }
}</code></pre></div>
<p>完整代码以及对 <code>A + B Problem</code> 的测试在 GitHub 上：<a href="https://github.com/MeiK2333/ZeroJudger/tree/master/baserun">https://github.com/MeiK2333/ZeroJudger/tree/master/baserun</a>。</p>

<h2 id="总结">总结</h2>

<p>本篇讲解了实现一个评测姬最重要的核心功能：编译、执行用户代码。配合上一篇的评测函数，现在我们已经可以实现一个最基本的评测姬了。但这样还不够，评测姬会执行用户提交的代码，用户是有可能会提交恶意的代码的，我们需要某些手段来保证评测姬的安全。下一篇我们就来看看如何保证评测姬的安全。</p>

    
      <code class="text-bold">Tags</code> 
      
        <a class="chip text-accent" href="https://meik2333.com/tags/onlinejudge">OnlineJudge</a>
      
        <a class="chip text-accent" href="https://meik2333.com/tags/%E8%AF%84%E6%B5%8B%E5%A7%AC">评测姬</a>
      
    
  </section>
  <div class="divider my-gap"></div>
  <footer class="col-12 d-inline-block">
    <span class="float-left">
      <button class="btn btn-action btn-accent shadow s-circle" onclick="window.history.back();"><i class="fas fa-arrow-left"></i></button>
    </span>
    <span class="float-right">
      <div class="text-right float-left mx-2">
        <span class="text-dark"></span><br>
        <span class="text-gray"></span>
      </div>
      <figure class="avatar avatar-lg">
        <img id="profile">
      </figure>
    </span>
  </footer>
</article>

    <footer class="container p-centered text-center my-gap">
  

  <small class="text-gray">
  
    © Copyright 2019 
  
  </small>
</footer>

  </div>
  </section>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://meik2333.com/js/main.js"></script>
<script src="https://meik2333.com/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-107784973-4', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
</html>
