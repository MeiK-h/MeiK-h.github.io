<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  
  <meta name="generator" content="Hugo 0.58.3" />

  <title>如何写一个爬虫 - 第三篇 &middot; MeiK&#39;s blog</title>

  <link rel="shortcut icon" href="https://meik2333.com/images/favicon.ico">
  <link rel="stylesheet" href="https://meik2333.com/css/spectre.min.css">
  <link rel="stylesheet" href="https://meik2333.com/css/style.css">
  <link rel="stylesheet" href="https://meik2333.com/css/highlight.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css">
  

  

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-107784973-4', 'auto');
	
	ga('send', 'pageview');
}
</script>

  <meta property="og:title" content="如何写一个爬虫 - 第三篇" />
<meta property="og:description" content="从零开始实现一个爬虫。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://meik2333.com/posts/crawler3/" />
<meta property="article:published_time" content="2019-08-16T14:00:57+00:00" />
<meta property="article:modified_time" content="2019-08-16T14:00:57+00:00" />

  
  <meta itemprop="name" content="如何写一个爬虫 - 第三篇">
<meta itemprop="description" content="从零开始实现一个爬虫。">


<meta itemprop="datePublished" content="2019-08-16T14:00:57&#43;00:00" />
<meta itemprop="dateModified" content="2019-08-16T14:00:57&#43;00:00" />
<meta itemprop="wordCount" content="469">



<meta itemprop="keywords" content="爬虫,Python," />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="如何写一个爬虫 - 第三篇"/>
<meta name="twitter:description" content="从零开始实现一个爬虫。"/>

</head>

<body onload="setPixelFont()">
  <div class="container p-fixed" style="z-index:3">
  <nav class="navbar m-2 p-2 s-rounded shadow bg-primary">
    <section class="navbar-section">
      <button class="btn btn-action btn-primary s-circle text-gray" id="pixelfont-toggle"><i class="fas fa-robot fa-lg"></i></button>
    </section>
    <section class="navbar-section">
      
        <a class="btn btn-primary" href='https://meik2333.com'>Home</a>
      

      

      
    </section>
  </nav>
</div>

  <section class="container grid-md">
  <div class="columns">
    
    
<article class="container p-centered mt-space">
  <header>
    <h2 class="text-center">如何写一个爬虫 - 第三篇</h2>
    <h6 class="text-gray text-italic"></h6>
  </header>
  <section class="my-gap">
    <p>从零开始实现一个爬虫。</p>

<blockquote>
<p>&ldquo;But man is not made for defeat,&rdquo; he said. &ldquo;A man can be destroyed but not defeated.&rdquo;
“不过我得记住一点，人不是为失败而生的，”他说，“一个人可以被毁灭，但不能给打败。”&mdash;&mdash;《老人与海》 - 海明威</p>
</blockquote>

<p>我们已经有了一个可用的爬虫框架——虽然它只有一个函数 <code>fetch</code>。它的用法并不够明确，且直接返回 HTTP 响应的所有内容未免过于简单粗暴，这对我们用户的使用带来了很多困扰。因此，我们还需要对其进行改造，使我们的爬虫框架更加清晰与易用。</p>

<h2 id="request-与-response">Request 与 Response</h2>

<p>如果你曾经用某种语言写过 Web 应用的话，那应该对 <code>Request</code> 和 <code>Response</code> 并不陌生。一般我们将用户发送给服务器的请求称为 <code>Request</code> ，而服务器对用户返回的响应即为 <code>Response</code> 。</p>

<p>我们也使用 <code>Request</code> 与 <code>Response</code> 对框架进行封装，用户需要构造一个 <code>Request</code>来发送请求，并获得一个 <code>Response</code> 的实例。</p>

<p><code>Request</code> 沿用之前 <code>fetch</code> 的参数，而对于 <code>Response</code> ，我们先简单的做一下响应的解析。因此，两个类的定义分别如下：</p>

<p><strong>models.py/Request</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Request</span>(object):
    <span style="color:#66d9ef">def</span> __init__(
        self,
        method: str <span style="color:#f92672">=</span> None,
        url: str <span style="color:#f92672">=</span> None,
        headers: dict <span style="color:#f92672">=</span> None,
        data: str <span style="color:#f92672">=</span> None,
        params: dict <span style="color:#f92672">=</span> None,
    ):
        data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#66d9ef">if</span> data <span style="color:#f92672">is</span> None <span style="color:#66d9ef">else</span> data
        headers <span style="color:#f92672">=</span> {} <span style="color:#66d9ef">if</span> headers <span style="color:#f92672">is</span> None <span style="color:#66d9ef">else</span> headers
        params <span style="color:#f92672">=</span> {} <span style="color:#66d9ef">if</span> params <span style="color:#f92672">is</span> None <span style="color:#66d9ef">else</span> params

        self<span style="color:#f92672">.</span>method <span style="color:#f92672">=</span> method
        self<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> url
        self<span style="color:#f92672">.</span>headers <span style="color:#f92672">=</span> headers
        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> data
        self<span style="color:#f92672">.</span>params <span style="color:#f92672">=</span> params</code></pre></div>
<p><strong>models.py/Response</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Response</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, request, raw_content):
        self<span style="color:#f92672">.</span>raw_content <span style="color:#f92672">=</span> raw_content  <span style="color:#75715e"># 原始的响应内容</span>
        self<span style="color:#f92672">.</span>headers <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># 响应的 headers</span>
        self<span style="color:#f92672">.</span>content <span style="color:#f92672">=</span> None  <span style="color:#75715e"># 响应的正文内容</span>
        self<span style="color:#f92672">.</span>status_code <span style="color:#f92672">=</span> None  <span style="color:#75715e"># 响应的 HTTP 状态码</span>
        self<span style="color:#f92672">.</span>request <span style="color:#f92672">=</span> request  <span style="color:#75715e"># 对应的 Request</span></code></pre></div>
<p><code>Request</code> 与 <code>Response</code> 分别对应请求与响应的内容，我们认为一次（或同一站点的多次）与网站的交互为一次会话，请求与响应通过会话联系起来。因此为了将两个类联系起来，我们引入一个新的类 <code>Session</code> 。一个 <code>Session</code> 可能关联多个 <code>Request</code> 与 <code>Response</code> 。</p>

<p><strong>sessions.py/Session</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Session</span>(object):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send</span>(self, request: Request) <span style="color:#f92672">-&gt;</span> Response:
        <span style="color:#75715e"># 利用 fetch 函数，发送 Request 并返回 Response</span></code></pre></div>
<p>从这个版本开始，我们的代码量已经比较大了，因此在博客中将只介绍部分代码，具体代码需要读者去 <a href="https://github.com/MeiK2333/ZeroCrawler">GitHub</a> 上自行查看。我也推荐读者能自己敲一下完整的代码，从而对我们的爬虫框架有更深刻的理解。</p>

<p>实现了以上三个类的内容后，用户使用我们的框架的画风将是这样的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> ZeroCrawler.models <span style="color:#f92672">import</span> Request, Response
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> ZeroCrawler.sessions <span style="color:#f92672">import</span> Session
<span style="color:#f92672">&gt;&gt;&gt;</span> session <span style="color:#f92672">=</span> Session()  <span style="color:#75715e"># 实例化 Session</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> req <span style="color:#f92672">=</span> Request(method<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;get&#39;</span>, url<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;http://httpbin.org/get&#39;</span>)  <span style="color:#75715e"># 实例 Request</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> resp <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>send(req)  <span style="color:#75715e"># 发起请求</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">print</span>(resp)
<span style="color:#f92672">&lt;</span>Response [<span style="color:#ae81ff">200</span>]<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> resp<span style="color:#f92672">.</span>status_code
<span style="color:#ae81ff">200</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> resp<span style="color:#f92672">.</span>headers
{<span style="color:#e6db74">&#39;Access-Control-Allow-Credentials&#39;</span>: <span style="color:#e6db74">&#39;true&#39;</span>, <span style="color:#e6db74">&#39;Access-Control-Allow-Origin&#39;</span>: <span style="color:#e6db74">&#39;*&#39;</span>, <span style="color:#e6db74">&#39;Content-Type&#39;</span>: <span style="color:#e6db74">&#39;application/json&#39;</span>, <span style="color:#e6db74">&#39;Date&#39;</span>: <span style="color:#e6db74">&#39;Fri, 16 Aug 2019 07:40:38 GMT&#39;</span>, <span style="color:#e6db74">&#39;Referrer-Policy&#39;</span>: <span style="color:#e6db74">&#39;no-referrer-when-downgrade&#39;</span>, <span style="color:#e6db74">&#39;Server&#39;</span>: <span style="color:#e6db74">&#39;nginx&#39;</span>, <span style="color:#e6db74">&#39;X-Content-Type-Options&#39;</span>: <span style="color:#e6db74">&#39;nosniff&#39;</span>, <span style="color:#e6db74">&#39;X-Frame-Options&#39;</span>: <span style="color:#e6db74">&#39;DENY&#39;</span>, <span style="color:#e6db74">&#39;X-XSS-Protection&#39;</span>: <span style="color:#e6db74">&#39;1; mode=block&#39;</span>, <span style="color:#e6db74">&#39;Content-Length&#39;</span>: <span style="color:#e6db74">&#39;146&#39;</span>, <span style="color:#e6db74">&#39;Connection&#39;</span>: <span style="color:#e6db74">&#39;Close&#39;</span>}
<span style="color:#f92672">&gt;&gt;&gt;</span> resp<span style="color:#f92672">.</span>content
<span style="color:#e6db74">&#39;{</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">  &#34;args&#34;: {}, </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">  &#34;headers&#34;: {</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">    &#34;Host&#34;: &#34;httpbin.org&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">  }, </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">  &#34;origin&#34;: &#34;36.110.78.251, 36.110.78.251&#34;, </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">  &#34;url&#34;: &#34;https://httpbin.org/get&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span></code></pre></div>
<p>除了 <code>Response</code> 已经帮我们把数据解析出来了以外，看起来好像并没有比以前简洁多少。别慌，让我们再加点东西。</p>

<h2 id="人类可用的-api">人类可用的 API</h2>

<blockquote>
<p><strong>警告</strong>：非专业使用其他 HTTP 库会导致危险的副作用，包括：安全缺陷症、冗余代码症、重新发明轮子症、啃文档症、抑郁、头疼、甚至死亡。&mdash;&mdash; <a href="https://2.python-requests.org//zh_CN/latest/">Requests</a></p>
</blockquote>

<p>首先我们为 <code>Session</code> 添加两个函数，让我们可以在 <code>Session</code> 中使用 <code>with</code> ：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Session</span>(object):
    <span style="color:#66d9ef">def</span> __enter__(self):
        <span style="color:#66d9ef">return</span> self

    <span style="color:#66d9ef">def</span> __exit__(self, <span style="color:#f92672">*</span>args):
        <span style="color:#66d9ef">pass</span></code></pre></div>
<p>这让我们可以这样使用：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">with</span> sessions<span style="color:#f92672">.</span>Session() <span style="color:#66d9ef">as</span> session:
    resp <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>send(req)</code></pre></div>
<p>代码的缩进关系可以让我们更容易看出类之间的包含关系，当然这并不是我们修改的主要原因，下一章将具体介绍这段代码的作用，具体的优化在后面。</p>

<p>创建文件 <code>api.py</code> ，并写入如下内容：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> . <span style="color:#f92672">import</span> sessions

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">request</span>(method: str, url: str, <span style="color:#f92672">**</span>kwargs):
    <span style="color:#66d9ef">with</span> sessions<span style="color:#f92672">.</span>Session() <span style="color:#66d9ef">as</span> session:
        <span style="color:#66d9ef">return</span> session<span style="color:#f92672">.</span>request(method<span style="color:#f92672">=</span>method, url<span style="color:#f92672">=</span>url, <span style="color:#f92672">**</span>kwargs)</code></pre></div>
<p>现在我们使用它的方法变成了这样：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> ZeroCrawler.api <span style="color:#f92672">import</span> request
<span style="color:#f92672">&gt;&gt;&gt;</span> resp <span style="color:#f92672">=</span> request(<span style="color:#e6db74">&#39;get&#39;</span>, <span style="color:#e6db74">&#39;http://httpbin.org/get&#39;</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> resp<span style="color:#f92672">.</span>status_code
<span style="color:#ae81ff">200</span></code></pre></div>
<p>是不是很简单？我们还能让它更简单一点。在上一章中我们介绍了 HTTP 的请求方法，目前共有九种，我们可以为这九种（其实是七种，因为有两种 <code>CONNECT</code> 和 <code>TRACE</code> 是用于 HTTP 调试的）来创建“快捷方式”：</p>

<p><strong>api.py</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(url: str, params: dict <span style="color:#f92672">=</span> None, <span style="color:#f92672">**</span>kwargs):
    <span style="color:#66d9ef">return</span> request(<span style="color:#e6db74">&#34;get&#34;</span>, url, params<span style="color:#f92672">=</span>params, <span style="color:#f92672">**</span>kwargs)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">post</span>(url: str, data: str <span style="color:#f92672">=</span> None, <span style="color:#f92672">**</span>kwargs):
    <span style="color:#66d9ef">return</span> request(<span style="color:#e6db74">&#34;post&#34;</span>, url, data<span style="color:#f92672">=</span>data, <span style="color:#f92672">**</span>kwargs)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">options</span>(url: str, <span style="color:#f92672">**</span>kwargs):  <span style="color:#75715e"># ...</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">head</span>(url: str, <span style="color:#f92672">**</span>kwargs):  <span style="color:#75715e"># ...</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">put</span>(url: str, data: str <span style="color:#f92672">=</span> None, <span style="color:#f92672">**</span>kwargs):  <span style="color:#75715e"># ...</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">patch</span>(url: str, data: str <span style="color:#f92672">=</span> None, <span style="color:#f92672">**</span>kwargs):  <span style="color:#75715e"># ...</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete</span>(url: str, <span style="color:#f92672">**</span>kwargs):  <span style="color:#75715e"># ...</span></code></pre></div>
<p>最终，我们的用法变成了这样：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> ZeroCrawler.api <span style="color:#f92672">import</span> get
<span style="color:#f92672">&gt;&gt;&gt;</span> resp <span style="color:#f92672">=</span> get(<span style="color:#e6db74">&#39;http://httpbin.org/get&#39;</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> resp<span style="color:#f92672">.</span>status_code
<span style="color:#ae81ff">200</span></code></pre></div>
<p>简单明了，符合我们的期望。</p>

<h2 id="总结">总结</h2>

<p>如果你用过 Python 中的 <code>requests</code> 库的话，会发现我们的 API 与它的 API 极其相似——因为我是照着它的 API 来写的。</p>

<p>ZeroCrawler 的整个设计都是借鉴的早期版本的 <code>requests</code> ，我们就是在循序渐进的造一个迷你版的 <code>requests</code> 。同样是从基础开始学习，比起跟着质量良莠不齐的各种教程，我更希望读者能一开始就跟着业内最高质量的开源项目来学习。过程中可能有很多精华在我转换的过程中丢失了，如果有遗漏之处，请读者告知。</p>

<p>照例，本版本的项目源码在 GitHub 上：<a href="https://github.com/MeiK2333/ZeroCrawler/tree/46f8803797095db0ebaad12f44a5227b09f2de5a">ZeroCrawler Version 0.1.0</a> ，从这个版本开始，我们的 API 将基本定型，之后的更新也不会破坏之前的 API 。为了表示我们 API 已经稳定了，我们将版本从 0.0.2 直接提升到了 0.1.0 。</p>

<p>至此，我们的爬虫框架已经支持基础的爬虫功能了。但我们对 1.0 及之后的特性、 HTTP header 的具体行为还没有支持，之后的章节我们会依次介绍这些特性并支持它们，还请多多关注。</p>

    
      <code class="text-bold">Tags</code> 
      
        <a class="chip text-accent" href="https://meik2333.com/tags/%E7%88%AC%E8%99%AB">爬虫</a>
      
        <a class="chip text-accent" href="https://meik2333.com/tags/python">Python</a>
      
    
  </section>
  <div class="divider my-gap"></div>
  <footer class="col-12 d-inline-block">
    <span class="float-left">
      <button class="btn btn-action btn-accent shadow s-circle" onclick="window.history.back();"><i class="fas fa-arrow-left"></i></button>
    </span>
    <span class="float-right">
      <div class="text-right float-left mx-2">
        <span class="text-dark"></span><br>
        <span class="text-gray"></span>
      </div>
      <figure class="avatar avatar-lg">
        <img id="profile">
      </figure>
    </span>
  </footer>
</article>

    <footer class="container p-centered text-center my-gap">
  

  <small class="text-gray">
  
    © Copyright 2019 
  
  </small>
</footer>

  </div>
  </section>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://meik2333.com/js/main.js"></script>
<script src="https://meik2333.com/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-107784973-4', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
</html>
