<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>MeiK&#39;s blog  | 如何写一个爬虫 - 第三篇</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.58.3" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    
    
    <meta property="og:title" content="如何写一个爬虫 - 第三篇" />
<meta property="og:description" content="从零开始实现一个爬虫。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://meik2333.com/posts/crawler3/" />
<meta property="article:published_time" content="2019-08-16T14:00:57+00:00" />
<meta property="article:modified_time" content="2019-08-16T14:00:57+00:00" />
<meta itemprop="name" content="如何写一个爬虫 - 第三篇">
<meta itemprop="description" content="从零开始实现一个爬虫。">


<meta itemprop="datePublished" content="2019-08-16T14:00:57&#43;00:00" />
<meta itemprop="dateModified" content="2019-08-16T14:00:57&#43;00:00" />
<meta itemprop="wordCount" content="475">



<meta itemprop="keywords" content="爬虫,Python," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="如何写一个爬虫 - 第三篇"/>
<meta name="twitter:description" content="从零开始实现一个爬虫。"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://meik2333.com" class="f3 fw2 hover-white no-underline white-90 dib">
      MeiK&#39;s blog
    </a>
    <div class="flex-l items-center">
      

      
      











    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">如何写一个爬虫 - 第三篇</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2019-08-16T14:00:57Z">August 16, 2019</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>从零开始实现一个爬虫。</p>

<blockquote>
<p>&ldquo;But man is not made for defeat,&rdquo; he said. &ldquo;A man can be destroyed but not defeated.&rdquo;
“不过我得记住一点，人不是为失败而生的，”他说，“一个人可以被毁灭，但不能给打败。”&mdash;&mdash;《老人与海》 - 海明威</p>
</blockquote>

<p>我们已经有了一个可用的爬虫框架——虽然它只有一个函数 <code>fetch</code>。它的用法并不够明确，且直接返回 HTTP 响应的所有内容未免过于简单粗暴，这对我们用户的使用带来了很多困扰。因此，我们还需要对其进行改造，使我们的爬虫框架更加清晰与易用。</p>

<h2 id="request-与-response">Request 与 Response</h2>

<p>如果你曾经用某种语言写过 Web 应用的话，那应该对 <code>Request</code> 和 <code>Response</code> 并不陌生。一般我们将用户发送给服务器的请求称为 <code>Request</code> ，而服务器对用户返回的响应即为 <code>Response</code> 。</p>

<p>我们也使用 <code>Request</code> 与 <code>Response</code> 对框架进行封装，用户需要构造一个 <code>Request</code>来发送请求，并获得一个 <code>Response</code> 的实例。</p>

<p><code>Request</code> 沿用之前 <code>fetch</code> 的参数，而对于 <code>Response</code> ，我们先简单的做一下响应的解析。因此，两个类的定义分别如下：</p>

<p><strong>models.py/Request</strong></p>

<pre><code class="language-python">class Request(object):
    def __init__(
        self,
        method: str = None,
        url: str = None,
        headers: dict = None,
        data: str = None,
        params: dict = None,
    ):
        data = &quot;&quot; if data is None else data
        headers = {} if headers is None else headers
        params = {} if params is None else params

        self.method = method
        self.url = url
        self.headers = headers
        self.data = data
        self.params = params
</code></pre>

<p><strong>models.py/Response</strong></p>

<pre><code class="language-python">class Response(object):
    def __init__(self, request, raw_content):
        self.raw_content = raw_content  # 原始的响应内容
        self.headers = {}  # 响应的 headers
        self.content = None  # 响应的正文内容
        self.status_code = None  # 响应的 HTTP 状态码
        self.request = request  # 对应的 Request
</code></pre>

<p><code>Request</code> 与 <code>Response</code> 分别对应请求与响应的内容，我们认为一次（或同一站点的多次）与网站的交互为一次会话，请求与响应通过会话联系起来。因此为了将两个类联系起来，我们引入一个新的类 <code>Session</code> 。一个 <code>Session</code> 可能关联多个 <code>Request</code> 与 <code>Response</code> 。</p>

<p><strong>sessions.py/Session</strong></p>

<pre><code class="language-python">class Session(object):
    def send(self, request: Request) -&gt; Response:
        # 利用 fetch 函数，发送 Request 并返回 Response
</code></pre>

<p>从这个版本开始，我们的代码量已经比较大了，因此在博客中将只介绍部分代码，具体代码需要读者去 <a href="https://github.com/MeiK2333/ZeroCrawler">GitHub</a> 上自行查看。我也推荐读者能自己敲一下完整的代码，从而对我们的爬虫框架有更深刻的理解。</p>

<p>实现了以上三个类的内容后，用户使用我们的框架的画风将是这样的：</p>

<pre><code class="language-python">&gt;&gt;&gt; from ZeroCrawler.models import Request, Response
&gt;&gt;&gt; from ZeroCrawler.sessions import Session
&gt;&gt;&gt; session = Session()  # 实例化 Session
&gt;&gt;&gt; req = Request(method='get', url='http://httpbin.org/get')  # 实例 Request
&gt;&gt;&gt; resp = session.send(req)  # 发起请求
&gt;&gt;&gt; print(resp)
&lt;Response [200]&gt;
&gt;&gt;&gt; resp.status_code
200
&gt;&gt;&gt; resp.headers
{'Access-Control-Allow-Credentials': 'true', 'Access-Control-Allow-Origin': '*', 'Content-Type': 'application/json', 'Date': 'Fri, 16 Aug 2019 07:40:38 GMT', 'Referrer-Policy': 'no-referrer-when-downgrade', 'Server': 'nginx', 'X-Content-Type-Options': 'nosniff', 'X-Frame-Options': 'DENY', 'X-XSS-Protection': '1; mode=block', 'Content-Length': '146', 'Connection': 'Close'}
&gt;&gt;&gt; resp.content
'{\n  &quot;args&quot;: {}, \n  &quot;headers&quot;: {\n    &quot;Host&quot;: &quot;httpbin.org&quot;\n  }, \n  &quot;origin&quot;: &quot;36.110.78.251, 36.110.78.251&quot;, \n  &quot;url&quot;: &quot;https://httpbin.org/get&quot;\n}\n'
</code></pre>

<p>除了 <code>Response</code> 已经帮我们把数据解析出来了以外，看起来好像并没有比以前简洁多少。别慌，让我们再加点东西。</p>

<h2 id="人类可用的-api">人类可用的 API</h2>

<blockquote>
<p><strong>警告</strong>：非专业使用其他 HTTP 库会导致危险的副作用，包括：安全缺陷症、冗余代码症、重新发明轮子症、啃文档症、抑郁、头疼、甚至死亡。&mdash;&mdash; <a href="https://2.python-requests.org//zh_CN/latest/">Requests</a></p>
</blockquote>

<p>首先我们为 <code>Session</code> 添加两个函数，让我们可以在 <code>Session</code> 中使用 <code>with</code> ：</p>

<pre><code class="language-python">class Session(object):
    def __enter__(self):
        return self

    def __exit__(self, *args):
        pass
</code></pre>

<p>这让我们可以这样使用：</p>

<pre><code class="language-python">with sessions.Session() as session:
    resp = session.send(req)
</code></pre>

<p>代码的缩进关系可以让我们更容易看出类之间的包含关系，当然这并不是我们修改的主要原因，下一章将具体介绍这段代码的作用，具体的优化在后面。</p>

<p>创建文件 <code>api.py</code> ，并写入如下内容：</p>

<pre><code class="language-python">from . import sessions

def request(method: str, url: str, **kwargs):
    with sessions.Session() as session:
        return session.request(method=method, url=url, **kwargs)
</code></pre>

<p>现在我们使用它的方法变成了这样：</p>

<pre><code class="language-python">&gt;&gt;&gt; from ZeroCrawler.api import request
&gt;&gt;&gt; resp = request('get', 'http://httpbin.org/get')
&gt;&gt;&gt; resp.status_code
200
</code></pre>

<p>是不是很简单？我们还能让它更简单一点。在上一章中我们介绍了 HTTP 的请求方法，目前共有九种，我们可以为这九种（其实是七种，因为有两种 <code>CONNECT</code> 和 <code>TRACE</code> 是用于 HTTP 调试的）来创建“快捷方式”：</p>

<p><strong>api.py</strong></p>

<pre><code class="language-python">def get(url: str, params: dict = None, **kwargs):
    return request(&quot;get&quot;, url, params=params, **kwargs)

def post(url: str, data: str = None, **kwargs):
    return request(&quot;post&quot;, url, data=data, **kwargs)

def options(url: str, **kwargs):  # ...
def head(url: str, **kwargs):  # ...
def put(url: str, data: str = None, **kwargs):  # ...
def patch(url: str, data: str = None, **kwargs):  # ...
def delete(url: str, **kwargs):  # ...
</code></pre>

<p>最终，我们的用法变成了这样：</p>

<pre><code class="language-python">&gt;&gt;&gt; from ZeroCrawler.api import get
&gt;&gt;&gt; resp = get('http://httpbin.org/get')
&gt;&gt;&gt; resp.status_code
200
</code></pre>

<p>简单明了，符合我们的期望。</p>

<h2 id="总结">总结</h2>

<p>如果你用过 Python 中的 <code>requests</code> 库的话，会发现我们的 API 与它的 API 极其相似——因为我是照着它的 API 来写的。</p>

<p>ZeroCrawler 的整个设计都是借鉴的早期版本的 <code>requests</code> ，我们就是在循序渐进的造一个迷你版的 <code>requests</code> 。同样是从基础开始学习，比起跟着质量良莠不齐的各种教程，我更希望读者能一开始就跟着业内最高质量的开源项目来学习。过程中可能有很多精华在我转换的过程中丢失了，如果有遗漏之处，请读者告知。</p>

<p>照例，本版本的项目源码在 GitHub 上：<a href="https://github.com/MeiK2333/ZeroCrawler/tree/46f8803797095db0ebaad12f44a5227b09f2de5a">ZeroCrawler Version 0.1.0</a> ，从这个版本开始，我们的 API 将基本定型，之后的更新也不会破坏之前的 API 。为了表示我们 API 已经稳定了，我们将版本从 0.0.2 直接提升到了 0.1.0 。</p>

<p>至此，我们的爬虫框架已经支持基础的爬虫功能了。但我们对 1.0 及之后的特性、 HTTP header 的具体行为还没有支持，之后的章节我们会依次介绍这些特性并支持它们，还请多多关注。</p><ul class="pa0">
  
   <li class="list">
     <a href="/tags/%E7%88%AC%E8%99%AB" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">爬虫</a>
   </li>
  
   <li class="list">
     <a href="/tags/python" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Python</a>
   </li>
  
</ul>
<div class="mt6">
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/crawler2/">如何写一个爬虫 - 第二篇</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/crawler1/">如何写一个爬虫 - 第一篇</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/fix-bug/">我是如何找到一个 BUG 的</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/get-web-qqmusic-download-link/">通过网页 QQ 音乐获取音乐的下载地址</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/django-dynamically-changes-file-upload-path/">Django 动态更改文件上传路径</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/python-generates-dynamic-ascii-painting/">Python 生成动态字符画</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/unit-testing-in-python/">Python 中的单元测试（ unittest 的基础用法）</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/django-tutorial/">Django tutorial</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/django-model-field-reference-field-options/">Django Model field reference - Field options</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/django-model-field-reference-field-types/">Django Model field reference - Field types</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://meik2333.com" >
    &copy; 2019 MeiK&#39;s blog
  </a>
    <div>










</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
