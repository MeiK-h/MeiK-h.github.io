<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <link crossorigin="anonymous" media="all"
        integrity="sha512-4bmhxCob3U2WoK8HVl7UacoDdNejo+50BlGN9SdGtjXbsCQwp7uLtntLkL9a9CmgLPZ8L9lsOZL0ieINT9yHeA=="
        rel="stylesheet"
        href="https://github.githubassets.com/assets/frameworks-2fd1891c9e6292401a1a3de8bc3f747f.css" />
    <link crossorigin="anonymous" media="all"
        integrity="sha512-oF4BPgLoJ4I8H6vdTzR4cGdwAF4bC/bdeI7zsQ/xzUbUWc+JU6xeSbOxIgOyelZP+1ESc5qfwDKzYQfdDNlX5Q=="
        rel="stylesheet" href="https://github.githubassets.com/assets/github-5238587550334d8b43fd71226c6de55c.css" />
    <meta name="viewport" content="width=device-width">

    <title>MeiK&#39;s blog</title>

    <meta name="description" content="">
    <link rel="assets" href="https://github.githubassets.com/">
    <link rel="mask-icon" href="https://github.githubassets.com/pinned-octocat.svg" color="#000000">
    <link rel="icon" type="image/x-icon" class="js-site-favicon" href="https://meik2333.com/images/favicon.ico">
    <meta name="theme-color" content="#1e2327">
</head>

<body class="env-production emoji-size-boost page-responsive page-profile">
  <div class="position-relative js-header-wrapper ">
    <span class="Progress progress-pjax-loader position-fixed width-full js-pjax-loader-bar">
        <span class="progress-pjax-loader-bar top-0 left-0" style="width: 0%;"></span>
    </span>
    <header class="Header js-details-container Details flex-wrap flex-lg-nowrap p-responsive" role="banner">
        <div class="Header-item d-none d-lg-flex">
            <a class="Header-link" href="https://meik2333.com/" aria-label="Homepage"
                data-ga-click="Header, go to dashboard, icon:logo">
                <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
                    width="32" aria-hidden="true">
                    <path fill-rule="evenodd"
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" />
                </svg>
            </a>
        </div>
        <div
            class="Header-item Header-item--full flex-column flex-lg-row width-full flex-order-2 flex-lg-order-none mr-0 mr-lg-3 mt-3 mt-lg-0 Details-content--hidden">
            <div class="header-search flex-self-stretch flex-lg-self-auto mr-0 mr-lg-3 mb-3 mb-lg-0 scoped-search site-scoped-search js-site-search position-relative js-jump-to"
                role="combobox" aria-owns="jump-to-results" aria-label="Search or jump to" aria-haspopup="listbox"
                aria-expanded="false">
                <div class="position-relative">
                </div>
            </div>
        </div>
        <div class="Header-item Header-item--full flex-justify-center d-lg-none position-relative">
            <a class="Header-link" href="https://meik2333.com/" aria-label="Homepage"
                data-ga-click="Header, go to dashboard, icon:logo">
                <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
                    width="32" aria-hidden="true">
                    <path fill-rule="evenodd"
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" />
                </svg>
            </a>
        </div>
        <div class="Header-item position-relative mr-0 d-none d-lg-flex">
            <details class="details-overlay details-reset">
                <summary class="Header-link" aria-label="View profile and more"
                    data-ga-click="Header, show menu, icon:avatar">
                    <img alt="" class="avatar" src="https://meik2333.com/images/avatar.png" height="20" width="20">
                </summary>
            </details>
        </div>
    </header>
</div>

<div id="start-of-content" class="show-on-focus"></div>
<div id="js-flash-container">
</div>
  
<div class="application-main " data-commit-hovercards-enabled="">
    <div itemscope="" itemtype="http://schema.org/SoftwareSourceCode" class="">
        <main id="js-repo-pjax-container" data-pjax-container="">
            <div class="pagehead repohead instapaper_ignore readability-menu experiment-repo-nav pt-0 pt-lg-4 ">
                <div class="repohead-details-container clearfix container-lg p-responsive d-none d-lg-block">
                    <div class="mb-3 d-flex">
                        <h1 class="public css-truncate float-none flex-auto width-fit pl-0">
                            <a class="avatar mr-1" href="https://meik2333.com/about/"><img
                                    src="https://meik2333.com/images/avatar.png" width="26" height="26"></a>
                            <span class="author"><a
                                    href="https://meik2333.com/about/">MeiK</a></span>
                            <span class="path-divider">/</span>
                            <strong itemprop="name" class="css-truncate-target" style="max-width: 410px"><a
                                    href="/posts/webbench-source-and-analysis/">WebBench 源码分析 [不推荐阅读]</a></strong>

                            <div class="d-block text-small text-gray">
                                Created <time-ago datetime="2018-07-19" class="no-wrap"
                                    title="Created at 2018/07/19">
                                    2018-07-19</time-ago>
                                <span class="file-info-divider"></span>
                                Modifyd <time-ago datetime="2018-07-19" class="no-wrap"
                                    title="Modifyd at 2018/07/19">
                                    2018-07-19</time-ago>
                            </div>
                        </h1>
                    </div>
                </div>




            </div>
            <div class="container-lg clearfix new-discussion-timeline experiment-repo-nav  p-responsive">
                <div class="repository-content ">
                    <div class="Box mt-3 position-relative">
                        <div class="Box-header py-2 d-flex flex-column flex-shrink-0 flex-md-row flex-md-items-center">
                            <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                                3031 Words
                                <span class="file-info-divider"></span>
                                10 min
                            </div>
                        </div>

                        <div id="readme" class="Box-body readme blob instapaper_body js-code-block-container">
                            <article class="markdown-body entry-content p-3 p-md-6" itemprop="text"><p>在学习的过程中, 总是要阅读很多别人的代码的. 很多优秀的开源代码能够让我们受益匪浅, 也有一些代码, 看了之后只会让我们感觉浪费了时间&hellip;&hellip;</p>

<p>Webbench是Radim Kolar在1997年写的一个在linux下使用的非常简单的网站压测工具。它使用fork()模拟多个客户端同时访问我们设定的URL，测试网站在压力下工作的性能，最多可以模拟3万个并发连接去测试网站的负载能力。</p>

<h2 id="问题">问题</h2>

<p>看完这个项目之后, 我注意到了这个项目的一些问题</p>

<ul>
<li>滥用全局变量</li>
<li>一个函数将一个全局变量作为函数参数传递给了另一个函数</li>
<li>代码风格不一致, 同样的功能(获取指定字符串位置)用了好几种不同的办法, 还混写在了一起</li>
<li><code>strcat(str1 + strlen(str1), str2)</code> 这种神奇的操作</li>
<li>可能会创建多个子进程(文档描述中说明可以上万个), 却只判断了最后一个是否成功</li>
<li>使用 <code>sleep</code> 来调度父子进程的先后关系</li>
<li>管道没有关闭不需要的一端</li>
<li>奇怪的变量复用, 比如在子进程中用 <code>pid</code> 又去表示了 <code>fscanf</code> 的返回值</li>
<li>&hellip;&hellip;</li>
</ul>

<h2 id="建议">建议</h2>

<p>不要看这个项目! 不要看这个项目! 不要看这个项目!</p>

<p>除非你想要从中获得什么反面的教学用例</p>

<p>如果你想要通过一个代码并不长、并不复杂的项目来学习一个 HTTP 服务相关的话, 那么我推荐 <a href="/2018/06/29/Tinyhttpd-源码及分析/">Tinyhttpd 源码及分析</a>. 虽然那个项目也有一些问题, 只能作为一个玩具使用, 但是对于学习来说是有一定意义的.</p>

<h2 id="源代码">源代码</h2>

<p>我居然用了一个多小时的时间看完了他的源代码并且加上了注释&hellip;&hellip;</p>

<h3 id="socket-c">socket.c</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">/* $Id: socket.c 1.1 1995/01/01 07:11:14 cthuang Exp $
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * This module has been modified by Radim Kolar for OS/2 emx
</span><span style="color:#75715e"> */</span>

<span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">  module:       socket.c
</span><span style="color:#75715e">  program:      popclient
</span><span style="color:#75715e">  SCCS ID:      @(#)socket.c    1.5  4/1/94
</span><span style="color:#75715e">  programmer:   Virginia Tech Computing Center
</span><span style="color:#75715e">  compiler:     DEC RISC C compiler (Ultrix 4.1)
</span><span style="color:#75715e">  environment:  DEC Ultrix 4.3
</span><span style="color:#75715e">  description:  UNIX sockets code.
</span><span style="color:#75715e"> ***********************************************************************/</span>

<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdarg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/time.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Socket</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">int</span> clientPort) {
    <span style="color:#66d9ef">int</span> sock;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> inaddr;
    <span style="color:#66d9ef">struct</span> sockaddr_in ad;
    <span style="color:#66d9ef">struct</span> hostent <span style="color:#f92672">*</span>hp;

    memset(<span style="color:#f92672">&amp;</span>ad, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(ad));
    ad.sin_family <span style="color:#f92672">=</span> AF_INET;

    <span style="color:#75715e">/* 尝试以 IP 形式解析 */</span>
    inaddr <span style="color:#f92672">=</span> inet_addr(host);
    <span style="color:#66d9ef">if</span> (inaddr <span style="color:#f92672">!=</span> INADDR_NONE)
        memcpy(<span style="color:#f92672">&amp;</span>ad.sin_addr, <span style="color:#f92672">&amp;</span>inaddr, <span style="color:#66d9ef">sizeof</span>(inaddr));
    <span style="color:#66d9ef">else</span> { <span style="color:#75715e">/* 如果解析失败, 则尝试通过 DNS 进行转换 */</span>
        <span style="color:#75715e">/* gethostbyname 是过时的函数, 应当使用 getaddrinfo 替换掉它 */</span>
        hp <span style="color:#f92672">=</span> gethostbyname(host);
        <span style="color:#66d9ef">if</span> (hp <span style="color:#f92672">==</span> NULL) <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
        memcpy(<span style="color:#f92672">&amp;</span>ad.sin_addr, hp<span style="color:#f92672">-&gt;</span>h_addr, hp<span style="color:#f92672">-&gt;</span>h_length);
    }
    ad.sin_port <span style="color:#f92672">=</span> htons(clientPort);

    <span style="color:#75715e">/* 创建 socket 连接 */</span>
    sock <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
    <span style="color:#66d9ef">if</span> (sock <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> sock;
    <span style="color:#66d9ef">if</span> (connect(sock, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>ad, <span style="color:#66d9ef">sizeof</span>(ad)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">return</span> sock;
}</code></pre></div>
<h3 id="webbench-c">webbench.c</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">/*
</span><span style="color:#75715e"> * (C) Radim Kolar 1997-2004
</span><span style="color:#75715e"> * This is free software, see GNU Public License version 2 for
</span><span style="color:#75715e"> * details.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Simple forking WWW Server benchmark:
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Usage:
</span><span style="color:#75715e"> *   webbench --help
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Return codes:
</span><span style="color:#75715e"> *    0 - sucess
</span><span style="color:#75715e"> *    1 - benchmark failed (server is not on-line)
</span><span style="color:#75715e"> *    2 - bad param
</span><span style="color:#75715e"> *    3 - internal error, fork failed
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> */</span>

<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;getopt.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;rpc/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;strings.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/param.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;time.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;socket.c&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/* values */</span>
<span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">int</span> timerexpired <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">int</span> speed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">int</span> failed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">int</span> bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

<span style="color:#75715e">/* globals */</span>
<span style="color:#66d9ef">int</span> http10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">/* 0 - http/0.9, 1 - http/1.0, 2 - http/1.1 */</span>
<span style="color:#75715e">/* Allow: GET, HEAD, OPTIONS, TRACE */</span>
<span style="color:#75715e">#define METHOD_GET 0
</span><span style="color:#75715e">#define METHOD_HEAD 1
</span><span style="color:#75715e">#define METHOD_OPTIONS 2
</span><span style="color:#75715e">#define METHOD_TRACE 3
</span><span style="color:#75715e">#define PROGRAM_VERSION &#34;1.5&#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> method <span style="color:#f92672">=</span> METHOD_GET;
<span style="color:#66d9ef">int</span> clients <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
<span style="color:#66d9ef">int</span> force <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">int</span> force_reload <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">int</span> proxyport <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>;
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>proxyhost <span style="color:#f92672">=</span> NULL;
<span style="color:#66d9ef">int</span> benchtime <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>;

<span style="color:#75715e">/* internal */</span>
<span style="color:#66d9ef">int</span> mypipe[<span style="color:#ae81ff">2</span>];
<span style="color:#66d9ef">char</span> host[MAXHOSTNAMELEN];
<span style="color:#75715e">#define REQUEST_SIZE 2048
</span><span style="color:#75715e"></span><span style="color:#66d9ef">char</span> request[REQUEST_SIZE];

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> option long_options[] <span style="color:#f92672">=</span> {
    {<span style="color:#e6db74">&#34;force&#34;</span>, no_argument, <span style="color:#f92672">&amp;</span>force, <span style="color:#ae81ff">1</span>},
    {<span style="color:#e6db74">&#34;reload&#34;</span>, no_argument, <span style="color:#f92672">&amp;</span>force_reload, <span style="color:#ae81ff">1</span>},
    {<span style="color:#e6db74">&#34;time&#34;</span>, required_argument, NULL, <span style="color:#e6db74">&#39;t&#39;</span>},
    {<span style="color:#e6db74">&#34;help&#34;</span>, no_argument, NULL, <span style="color:#e6db74">&#39;?&#39;</span>},
    {<span style="color:#e6db74">&#34;http09&#34;</span>, no_argument, NULL, <span style="color:#e6db74">&#39;9&#39;</span>},
    {<span style="color:#e6db74">&#34;http10&#34;</span>, no_argument, NULL, <span style="color:#e6db74">&#39;1&#39;</span>},
    {<span style="color:#e6db74">&#34;http11&#34;</span>, no_argument, NULL, <span style="color:#e6db74">&#39;2&#39;</span>},
    <span style="color:#75715e">/* 绑定命令行参数与变量 */</span>
    {<span style="color:#e6db74">&#34;get&#34;</span>, no_argument, <span style="color:#f92672">&amp;</span>method, METHOD_GET},
    {<span style="color:#e6db74">&#34;head&#34;</span>, no_argument, <span style="color:#f92672">&amp;</span>method, METHOD_HEAD},
    {<span style="color:#e6db74">&#34;options&#34;</span>, no_argument, <span style="color:#f92672">&amp;</span>method, METHOD_OPTIONS},
    {<span style="color:#e6db74">&#34;trace&#34;</span>, no_argument, <span style="color:#f92672">&amp;</span>method, METHOD_TRACE},
    {<span style="color:#e6db74">&#34;version&#34;</span>, no_argument, NULL, <span style="color:#e6db74">&#39;V&#39;</span>},
    {<span style="color:#e6db74">&#34;proxy&#34;</span>, required_argument, NULL, <span style="color:#e6db74">&#39;p&#39;</span>},
    {<span style="color:#e6db74">&#34;clients&#34;</span>, required_argument, NULL, <span style="color:#e6db74">&#39;c&#39;</span>},
    {NULL, <span style="color:#ae81ff">0</span>, NULL, <span style="color:#ae81ff">0</span>}};

<span style="color:#75715e">/* prototypes */</span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">benchcore</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> port, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>request);
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">bench</span>(<span style="color:#66d9ef">void</span>);
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">build_request</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url);

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">alarm_handler</span>(<span style="color:#66d9ef">int</span> signal) { timerexpired <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; }

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">usage</span>(<span style="color:#66d9ef">void</span>) {
    fprintf(
        stderr,
        <span style="color:#e6db74">&#34;webbench [option]... URL</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  -f|--force               Don&#39;t wait for reply from server.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  -r|--reload              Send reload request - Pragma: no-cache.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  -t|--time &lt;sec&gt;          Run benchmark for &lt;sec&gt; seconds. Default &#34;</span>
        <span style="color:#e6db74">&#34;30.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  -p|--proxy &lt;server:port&gt; Use proxy server for request.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  -c|--clients &lt;n&gt;         Run &lt;n&gt; HTTP clients at once. Default &#34;</span>
        <span style="color:#e6db74">&#34;one.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  -9|--http09              Use HTTP/0.9 style requests.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  -1|--http10              Use HTTP/1.0 protocol.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  -2|--http11              Use HTTP/1.1 protocol.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  --get                    Use GET request method.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  --head                   Use HEAD request method.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  --options                Use OPTIONS request method.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  --trace                  Use TRACE request method.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  -?|-h|--help             This information.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#e6db74">&#34;  -V|--version             Display program version.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
    <span style="color:#75715e">/* 读取命令行参数 */</span>
    <span style="color:#66d9ef">int</span> opt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> options_index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>tmp <span style="color:#f92672">=</span> NULL;

    <span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
        usage();
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span>;
    }

    <span style="color:#66d9ef">while</span> ((opt <span style="color:#f92672">=</span> getopt_long(argc, argv, <span style="color:#e6db74">&#34;912Vfrt:p:c:?h&#34;</span>, long_options,
                              <span style="color:#f92672">&amp;</span>options_index)) <span style="color:#f92672">!=</span> EOF) {
        <span style="color:#66d9ef">switch</span> (opt) {
            <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
                <span style="color:#66d9ef">break</span>;
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;f&#39;</span><span style="color:#f92672">:</span>
                <span style="color:#75715e">/* 设置 force 模式 */</span>
                force <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#66d9ef">break</span>;
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;r&#39;</span><span style="color:#f92672">:</span>
                <span style="color:#75715e">/* 设置 reload 模式 */</span>
                force_reload <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#66d9ef">break</span>;
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;9&#39;</span><span style="color:#f92672">:</span>
                <span style="color:#75715e">/* HTTP/0.9 */</span>
                http10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
                <span style="color:#66d9ef">break</span>;
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;1&#39;</span><span style="color:#f92672">:</span>
                <span style="color:#75715e">/* HTTP/1.0 */</span>
                http10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#66d9ef">break</span>;
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;2&#39;</span><span style="color:#f92672">:</span>
                <span style="color:#75715e">/* HTTP/1.1 */</span>
                http10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
                <span style="color:#66d9ef">break</span>;
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;V&#39;</span><span style="color:#f92672">:</span>
                <span style="color:#75715e">/* 打印版本信息并退出 */</span>
                printf(PROGRAM_VERSION <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
                exit(<span style="color:#ae81ff">0</span>);
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;t&#39;</span><span style="color:#f92672">:</span>
                <span style="color:#75715e">/* 设置运行时间 */</span>
                benchtime <span style="color:#f92672">=</span> atoi(optarg);
                <span style="color:#66d9ef">break</span>;
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;p&#39;</span><span style="color:#f92672">:</span>
                <span style="color:#75715e">/* proxy server parsing server:port */</span>
                <span style="color:#75715e">/**
</span><span style="color:#75715e">                 * 解析代理设置, 使用 &#34;:&#34; 分割代理字符串
</span><span style="color:#75715e">                 * eg: -p 127.0.0.1:1080
</span><span style="color:#75715e">                 * proxyhost(char *): &#34;127.0.0.1&#34;
</span><span style="color:#75715e">                 * proxyport(int): 1080
</span><span style="color:#75715e">                 * */</span>
                tmp <span style="color:#f92672">=</span> strrchr(optarg, <span style="color:#e6db74">&#39;:&#39;</span>);
                proxyhost <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">if</span> (tmp <span style="color:#f92672">==</span> NULL) {
                    <span style="color:#66d9ef">break</span>;
                }
                <span style="color:#75715e">/* 判断是否提供 hostname */</span>
                <span style="color:#66d9ef">if</span> (tmp <span style="color:#f92672">==</span> optarg) {
                    fprintf(stderr,
                            <span style="color:#e6db74">&#34;Error in option --proxy %s: Missing hostname.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
                            optarg);
                    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span>;
                }
                <span style="color:#75715e">/* 判断是否提供 port */</span>
                <span style="color:#66d9ef">if</span> (tmp <span style="color:#f92672">==</span> optarg <span style="color:#f92672">+</span> strlen(optarg) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) {
                    fprintf(
                        stderr,
                        <span style="color:#e6db74">&#34;Error in option --proxy %s Port number is missing.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
                        optarg);
                    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span>;
                }
                <span style="color:#f92672">*</span>tmp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
                proxyport <span style="color:#f92672">=</span> atoi(tmp <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
                <span style="color:#66d9ef">break</span>;
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;:&#39;</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;h&#39;</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;?&#39;</span><span style="color:#f92672">:</span>
                <span style="color:#75715e">/* 打印帮助 */</span>
                usage();
                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span>;
                <span style="color:#66d9ef">break</span>;
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;c&#39;</span><span style="color:#f92672">:</span>
                <span style="color:#75715e">/* 设置客户端个数 */</span>
                clients <span style="color:#f92672">=</span> atoi(optarg);
                <span style="color:#66d9ef">break</span>;
        }
    }

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * 当所有带选项的参数都已读取结束, optind
</span><span style="color:#75715e">     * 应当指向第一个不包含选项的命令行参数 若 optind == argc,
</span><span style="color:#75715e">     * 则代表没有不包含选项的命令行参数
</span><span style="color:#75715e">     * */</span>
    <span style="color:#66d9ef">if</span> (optind <span style="color:#f92672">==</span> argc) {
        fprintf(stderr, <span style="color:#e6db74">&#34;webbench: Missing URL!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        usage();
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span>;
    }

    <span style="color:#75715e">/* 设置 clients 和 benchtime 的默认值 */</span>
    <span style="color:#66d9ef">if</span> (clients <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) clients <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">if</span> (benchtime <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) benchtime <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>;

    <span style="color:#75715e">/* Copyright */</span>
    <span style="color:#75715e">/* 打印 Copyright */</span>
    fprintf(stderr,
            <span style="color:#e6db74">&#34;Webbench - Simple Web Benchmark &#34;</span> PROGRAM_VERSION
            <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
            <span style="color:#e6db74">&#34;Copyright (c) Radim Kolar 1997-2004, GPL Open Source Software.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    build_request(argv[optind]);

    <span style="color:#75715e">// print request info ,do it in function build_request
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/*printf(&#34;Benchmarking: &#34;);
</span><span style="color:#75715e">
</span><span style="color:#75715e">    switch(method)
</span><span style="color:#75715e">    {
</span><span style="color:#75715e">        case METHOD_GET:
</span><span style="color:#75715e">        default:
</span><span style="color:#75715e">        printf(&#34;GET&#34;);break;
</span><span style="color:#75715e">        case METHOD_OPTIONS:
</span><span style="color:#75715e">        printf(&#34;OPTIONS&#34;);break;
</span><span style="color:#75715e">        case METHOD_HEAD:
</span><span style="color:#75715e">        printf(&#34;HEAD&#34;);break;
</span><span style="color:#75715e">        case METHOD_TRACE:
</span><span style="color:#75715e">        printf(&#34;TRACE&#34;);break;
</span><span style="color:#75715e">    }
</span><span style="color:#75715e">
</span><span style="color:#75715e">    printf(&#34; %s&#34;,argv[optind]);
</span><span style="color:#75715e">
</span><span style="color:#75715e">    switch(http10)
</span><span style="color:#75715e">    {
</span><span style="color:#75715e">        case 0: printf(&#34; (using HTTP/0.9)&#34;);break;
</span><span style="color:#75715e">        case 2: printf(&#34; (using HTTP/1.1)&#34;);break;
</span><span style="color:#75715e">    }
</span><span style="color:#75715e">
</span><span style="color:#75715e">    printf(&#34;\n&#34;);
</span><span style="color:#75715e">    */</span>

    <span style="color:#75715e">/* 打印配置 */</span>
    printf(<span style="color:#e6db74">&#34;Runing info: &#34;</span>);

    <span style="color:#66d9ef">if</span> (clients <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)
        printf(<span style="color:#e6db74">&#34;1 client&#34;</span>);
    <span style="color:#66d9ef">else</span>
        printf(<span style="color:#e6db74">&#34;%d clients&#34;</span>, clients);

    printf(<span style="color:#e6db74">&#34;, running %d sec&#34;</span>, benchtime);

    <span style="color:#66d9ef">if</span> (force) printf(<span style="color:#e6db74">&#34;, early socket close&#34;</span>);
    <span style="color:#66d9ef">if</span> (proxyhost <span style="color:#f92672">!=</span> NULL)
        printf(<span style="color:#e6db74">&#34;, via proxy server %s:%d&#34;</span>, proxyhost, proxyport);
    <span style="color:#66d9ef">if</span> (force_reload) printf(<span style="color:#e6db74">&#34;, forcing reload&#34;</span>);

    printf(<span style="color:#e6db74">&#34;.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">/* 开始执行 */</span>
    <span style="color:#66d9ef">return</span> bench();
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">build_request</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url) {
    <span style="color:#66d9ef">char</span> tmp[<span style="color:#ae81ff">10</span>];
    <span style="color:#66d9ef">int</span> i;

    <span style="color:#75715e">// bzero(host,MAXHOSTNAMELEN);
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// bzero(request,REQUEST_SIZE);
</span><span style="color:#75715e"></span>    memset(host, <span style="color:#ae81ff">0</span>, MAXHOSTNAMELEN);
    memset(request, <span style="color:#ae81ff">0</span>, REQUEST_SIZE);

    <span style="color:#75715e">/* 根据 reload 和 method 等参数调整 HTTP */</span>
    <span style="color:#66d9ef">if</span> (force_reload <span style="color:#f92672">&amp;&amp;</span> proxyhost <span style="color:#f92672">!=</span> NULL <span style="color:#f92672">&amp;&amp;</span> http10 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>) http10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">if</span> (method <span style="color:#f92672">==</span> METHOD_HEAD <span style="color:#f92672">&amp;&amp;</span> http10 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>) http10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">if</span> (method <span style="color:#f92672">==</span> METHOD_OPTIONS <span style="color:#f92672">&amp;&amp;</span> http10 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) http10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
    <span style="color:#66d9ef">if</span> (method <span style="color:#f92672">==</span> METHOD_TRACE <span style="color:#f92672">&amp;&amp;</span> http10 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) http10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;

    <span style="color:#66d9ef">switch</span> (method) {
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
        <span style="color:#66d9ef">case</span> METHOD_GET:
            strcpy(request, <span style="color:#e6db74">&#34;GET&#34;</span>);
            <span style="color:#66d9ef">break</span>;
        <span style="color:#66d9ef">case</span> METHOD_HEAD:
            strcpy(request, <span style="color:#e6db74">&#34;HEAD&#34;</span>);
            <span style="color:#66d9ef">break</span>;
        <span style="color:#66d9ef">case</span> METHOD_OPTIONS:
            strcpy(request, <span style="color:#e6db74">&#34;OPTIONS&#34;</span>);
            <span style="color:#66d9ef">break</span>;
        <span style="color:#66d9ef">case</span> METHOD_TRACE:
            strcpy(request, <span style="color:#e6db74">&#34;TRACE&#34;</span>);
            <span style="color:#66d9ef">break</span>;
    }

    strcat(request, <span style="color:#e6db74">&#34; &#34;</span>);

    <span style="color:#75715e">/* 检查 URL 是否合法 */</span>
    <span style="color:#66d9ef">if</span> (NULL <span style="color:#f92672">==</span> strstr(url, <span style="color:#e6db74">&#34;://&#34;</span>)) {
        fprintf(stderr, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">%s: is not a valid URL.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, url);
        exit(<span style="color:#ae81ff">2</span>);
    }
    <span style="color:#75715e">/* 检查 URL 长度 */</span>
    <span style="color:#66d9ef">if</span> (strlen(url) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1500</span>) {
        fprintf(stderr, <span style="color:#e6db74">&#34;URL is too long.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        exit(<span style="color:#ae81ff">2</span>);
    }
    <span style="color:#75715e">/* 忽略大小写对比两个字符串的前 n 个字符 */</span>
    <span style="color:#75715e">/* 仅支持 HTTP 协议 */</span>
    <span style="color:#66d9ef">if</span> (<span style="color:#ae81ff">0</span> <span style="color:#f92672">!=</span> strncasecmp(<span style="color:#e6db74">&#34;http://&#34;</span>, url, <span style="color:#ae81ff">7</span>)) {
        fprintf(stderr,
                <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Only HTTP protocol is directly supported, set --proxy for &#34;</span>
                <span style="color:#e6db74">&#34;others.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        exit(<span style="color:#ae81ff">2</span>);
    }

    <span style="color:#75715e">/* protocol/host delimiter */</span>
    <span style="color:#75715e">/* 获得去掉协议后的 URL */</span>
    i <span style="color:#f92672">=</span> strstr(url, <span style="color:#e6db74">&#34;://&#34;</span>) <span style="color:#f92672">-</span> url <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>;

    <span style="color:#75715e">/* 判断 &#39;/&#39; 是否在 URL 中出现过 */</span>
    <span style="color:#66d9ef">if</span> (strchr(url <span style="color:#f92672">+</span> i, <span style="color:#e6db74">&#39;/&#39;</span>) <span style="color:#f92672">==</span> NULL) {
        fprintf(stderr,
                <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Invalid URL syntax - hostname don&#39;t ends with &#39;/&#39;.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        exit(<span style="color:#ae81ff">2</span>);
    }

    <span style="color:#75715e">/* url + i 指向 URL 去掉协议后的开头 */</span>
    <span style="color:#66d9ef">if</span> (proxyhost <span style="color:#f92672">==</span> NULL) {
        <span style="color:#75715e">/* get port from hostname */</span>
        <span style="color:#75715e">/**
</span><span style="color:#75715e">         * 如果没有使用代理, 则解析 URL 到 host 和 proxyport
</span><span style="color:#75715e">         * eg: http://127.0.0.1:8080/
</span><span style="color:#75715e">         * host(char *): 127.0.0.1
</span><span style="color:#75715e">         * proxyport(int): 8080
</span><span style="color:#75715e">         * */</span>
        <span style="color:#66d9ef">if</span> (index(url <span style="color:#f92672">+</span> i, <span style="color:#e6db74">&#39;:&#39;</span>) <span style="color:#f92672">!=</span> NULL <span style="color:#f92672">&amp;&amp;</span>
            index(url <span style="color:#f92672">+</span> i, <span style="color:#e6db74">&#39;:&#39;</span>) <span style="color:#f92672">&lt;</span> index(url <span style="color:#f92672">+</span> i, <span style="color:#e6db74">&#39;/&#39;</span>)) { <span style="color:#75715e">/* 如果指定了端口 */</span>
            strncpy(host, url <span style="color:#f92672">+</span> i, strchr(url <span style="color:#f92672">+</span> i, <span style="color:#e6db74">&#39;:&#39;</span>) <span style="color:#f92672">-</span> url <span style="color:#f92672">-</span> i);
            <span style="color:#75715e">// bzero(tmp,10);
</span><span style="color:#75715e"></span>            memset(tmp, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>);
            strncpy(tmp, index(url <span style="color:#f92672">+</span> i, <span style="color:#e6db74">&#39;:&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
                    strchr(url <span style="color:#f92672">+</span> i, <span style="color:#e6db74">&#39;/&#39;</span>) <span style="color:#f92672">-</span> index(url <span style="color:#f92672">+</span> i, <span style="color:#e6db74">&#39;:&#39;</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
            <span style="color:#75715e">/* printf(&#34;tmp=%s\n&#34;,tmp); */</span>
            proxyport <span style="color:#f92672">=</span> atoi(tmp);
            <span style="color:#66d9ef">if</span> (proxyport <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) proxyport <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>;
        } <span style="color:#66d9ef">else</span> { <span style="color:#75715e">/* 没有指定端口 */</span>
            strncpy(host, url <span style="color:#f92672">+</span> i, strcspn(url <span style="color:#f92672">+</span> i, <span style="color:#e6db74">&#34;/&#34;</span>));
        }
        <span style="color:#75715e">// printf(&#34;Host=%s\n&#34;,host);
</span><span style="color:#75715e"></span>        <span style="color:#75715e">/**
</span><span style="color:#75715e">         * 这个 request + strlen(request) 我实在是没看懂
</span><span style="color:#75715e">         * strlen 获得 request 后第一个 &#39;\0&#39; 的位置
</span><span style="color:#75715e">         * strcat 替换 request 后第一个 &#39;\0&#39; 并追加字符串, 在末尾添加 &#39;\0&#39;
</span><span style="color:#75715e">         * 那为什么要先找到 &#39;\0&#39; 的位置再去 strcat......
</span><span style="color:#75715e">         * */</span>
        strcat(request <span style="color:#f92672">+</span> strlen(request), url <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> strcspn(url <span style="color:#f92672">+</span> i, <span style="color:#e6db74">&#34;/&#34;</span>));
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// printf(&#34;ProxyHost=%s\nProxyPort=%d\n&#34;,proxyhost,proxyport);
</span><span style="color:#75715e"></span>        strcat(request, url);
    }

    <span style="color:#75715e">/* 拼接 HTTP 协议 */</span>
    <span style="color:#66d9ef">if</span> (http10 <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)
        strcat(request, <span style="color:#e6db74">&#34; HTTP/1.0&#34;</span>);
    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (http10 <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>)
        strcat(request, <span style="color:#e6db74">&#34; HTTP/1.1&#34;</span>);

    strcat(request, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">/* 拼接 UA */</span>
    <span style="color:#66d9ef">if</span> (http10 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
        strcat(request, <span style="color:#e6db74">&#34;User-Agent: WebBench &#34;</span> PROGRAM_VERSION <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#75715e">/* 拼接 Host */</span>
    <span style="color:#66d9ef">if</span> (proxyhost <span style="color:#f92672">==</span> NULL <span style="color:#f92672">&amp;&amp;</span> http10 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
        strcat(request, <span style="color:#e6db74">&#34;Host: &#34;</span>);
        strcat(request, host);
        strcat(request, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
    }

    <span style="color:#75715e">/* 拼接其余字段 */</span>
    <span style="color:#66d9ef">if</span> (force_reload <span style="color:#f92672">&amp;&amp;</span> proxyhost <span style="color:#f92672">!=</span> NULL) {
        strcat(request, <span style="color:#e6db74">&#34;Pragma: no-cache</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
    }

    <span style="color:#66d9ef">if</span> (http10 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>) strcat(request, <span style="color:#e6db74">&#34;Connection: close</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">/* add empty line at end */</span>
    <span style="color:#66d9ef">if</span> (http10 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) strcat(request, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);

    printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Request:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request);
}

<span style="color:#75715e">/* vraci system rc error kod */</span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">bench</span>(<span style="color:#66d9ef">void</span>) {
    <span style="color:#66d9ef">int</span> i, j, k;
    pid_t pid <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    FILE <span style="color:#f92672">*</span>f;

    <span style="color:#75715e">/* check avaibility of target server */</span>
    i <span style="color:#f92672">=</span> Socket(proxyhost <span style="color:#f92672">==</span> NULL <span style="color:#f92672">?</span> host : proxyhost, proxyport);
    <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
        fprintf(stderr, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Connect to server failed. Aborting benchmark.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
    }
    close(i);

    <span style="color:#75715e">/* create pipe */</span>
    <span style="color:#75715e">/* 创建管道 */</span>
    <span style="color:#66d9ef">if</span> (pipe(mypipe)) {
        perror(<span style="color:#e6db74">&#34;pipe failed.&#34;</span>);
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">3</span>;
    }

    <span style="color:#75715e">/* not needed, since we have alarm() in childrens */</span>
    <span style="color:#75715e">/* wait 4 next system clock tick */</span>
    <span style="color:#75715e">/*
</span><span style="color:#75715e">    cas=time(NULL);
</span><span style="color:#75715e">    while(time(NULL)==cas)
</span><span style="color:#75715e">    sched_yield();
</span><span style="color:#75715e">    */</span>

    <span style="color:#75715e">/* fork childs */</span>
    <span style="color:#75715e">/* 创建处理子进程 */</span>
    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> clients; i<span style="color:#f92672">++</span>) {
        pid <span style="color:#f92672">=</span> fork();
        <span style="color:#75715e">/* 不推荐将 fork 成功和失败的情况放在一起处理 */</span>
        <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">&lt;=</span> (pid_t)<span style="color:#ae81ff">0</span>) {
            <span style="color:#75715e">/* child process or error*/</span>
            <span style="color:#75715e">/* 你不能确定进程将于何时中断 */</span>
            <span style="color:#75715e">/* 因此这种方法并不推荐使用 */</span>
            sleep(<span style="color:#ae81ff">1</span>); <span style="color:#75715e">/* make childs faster */</span>
            <span style="color:#66d9ef">break</span>;
        }
    }

    <span style="color:#75715e">/* 这是? 创建了多个子进程, 然后判断最后一个 fork 是否成功? */</span>
    <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">&lt;</span> (pid_t)<span style="color:#ae81ff">0</span>) {
        fprintf(stderr, <span style="color:#e6db74">&#34;problems forking worker no. %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, i);
        perror(<span style="color:#e6db74">&#34;fork failed.&#34;</span>);
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">3</span>;
    }

    <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">==</span> (pid_t)<span style="color:#ae81ff">0</span>) {
        <span style="color:#75715e">/* I am a child */</span>
        <span style="color:#75715e">/* 开始发送请求 */</span>
        <span style="color:#75715e">/* 取全局变量中的 request 作为参数传给本文件内的另一个函数 */</span>
        <span style="color:#75715e">/* 什么写法...... */</span>
        <span style="color:#66d9ef">if</span> (proxyhost <span style="color:#f92672">==</span> NULL)
            benchcore(host, proxyport, request);
        <span style="color:#66d9ef">else</span>
            benchcore(proxyhost, proxyport, request);

        <span style="color:#75715e">/* write results to pipe */</span>
        <span style="color:#75715e">/* 将结果写入 pipe */</span>
        <span style="color:#75715e">/* 此处没有关闭 mypipe[0] */</span>
        <span style="color:#75715e">/* 不知是何用意 */</span>
        f <span style="color:#f92672">=</span> fdopen(mypipe[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;w&#34;</span>);
        <span style="color:#66d9ef">if</span> (f <span style="color:#f92672">==</span> NULL) {
            perror(<span style="color:#e6db74">&#34;open pipe for writing failed.&#34;</span>);
            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">3</span>;
        }
        <span style="color:#75715e">/* fprintf(stderr,&#34;Child - %d %d\n&#34;,speed,failed); */</span>
        fprintf(f, <span style="color:#e6db74">&#34;%d %d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, speed, failed, bytes);
        fclose(f);

        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">/* 同样的, 此处没有关闭 mypipe[1] */</span>
        f <span style="color:#f92672">=</span> fdopen(mypipe[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#34;r&#34;</span>);
        <span style="color:#66d9ef">if</span> (f <span style="color:#f92672">==</span> NULL) {
            perror(<span style="color:#e6db74">&#34;open pipe for reading failed.&#34;</span>);
            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">3</span>;
        }

        <span style="color:#75715e">/* 设置无缓冲 */</span>
        setvbuf(f, NULL, _IONBF, <span style="color:#ae81ff">0</span>);

        speed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        failed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

        <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
            pid <span style="color:#f92672">=</span> fscanf(f, <span style="color:#e6db74">&#34;%d %d %d&#34;</span>, <span style="color:#f92672">&amp;</span>i, <span style="color:#f92672">&amp;</span>j, <span style="color:#f92672">&amp;</span>k);
            <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) {
                fprintf(stderr, <span style="color:#e6db74">&#34;Some of our childrens died.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
                <span style="color:#66d9ef">break</span>;
            }

            speed <span style="color:#f92672">+=</span> i;
            failed <span style="color:#f92672">+=</span> j;
            bytes <span style="color:#f92672">+=</span> k;

            <span style="color:#75715e">/* fprintf(stderr,&#34;*Knock* %d %d read=%d\n&#34;,speed,failed,pid); */</span>
            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">--</span>clients <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">break</span>;
        }

        fclose(f);

        printf(
            <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Speed=%d pages/min, %d bytes/sec.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Requests: %d susceed, %d &#34;</span>
            <span style="color:#e6db74">&#34;failed.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
            (<span style="color:#66d9ef">int</span>)((speed <span style="color:#f92672">+</span> failed) <span style="color:#f92672">/</span> (benchtime <span style="color:#f92672">/</span> <span style="color:#ae81ff">60.0f</span>)),
            (<span style="color:#66d9ef">int</span>)(bytes <span style="color:#f92672">/</span> (<span style="color:#66d9ef">float</span>)benchtime), speed, failed);
    }

    <span style="color:#66d9ef">return</span> i;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">benchcore</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> port, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>req) {
    <span style="color:#66d9ef">int</span> rlen;
    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">1500</span>];
    <span style="color:#66d9ef">int</span> s, i;
    <span style="color:#66d9ef">struct</span> sigaction sa;

    <span style="color:#75715e">/* setup alarm signal handler */</span>
    <span style="color:#75715e">/* 设置 SIGALRM 信号的处理程序 */</span>
    sa.sa_handler <span style="color:#f92672">=</span> alarm_handler;
    sa.sa_flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">if</span> (sigaction(SIGALRM, <span style="color:#f92672">&amp;</span>sa, NULL)) exit(<span style="color:#ae81ff">3</span>);

    <span style="color:#75715e">/* 设置定时器, 超时产生 SIGALRM 信号 */</span>
    alarm(benchtime);  <span style="color:#75715e">// after benchtime,then exit
</span><span style="color:#75715e"></span>
    rlen <span style="color:#f92672">=</span> strlen(req);
nexttry:
    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">/**
</span><span style="color:#75715e">         * 一直重试(重新发送一遍)
</span><span style="color:#75715e">         * 直到超时
</span><span style="color:#75715e">         * 如果超时的话, 把 failed--(是说被计时器中断的那个不算错误吗?)
</span><span style="color:#75715e">         * */</span>
        <span style="color:#66d9ef">if</span> (timerexpired) {
            <span style="color:#66d9ef">if</span> (failed <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
                <span style="color:#75715e">/* fprintf(stderr,&#34;Correcting failed by signal\n&#34;); */</span>
                failed<span style="color:#f92672">--</span>;
            }
            <span style="color:#66d9ef">return</span>;
        }

        s <span style="color:#f92672">=</span> Socket(host, port);
        <span style="color:#66d9ef">if</span> (s <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
            failed<span style="color:#f92672">++</span>;
            <span style="color:#66d9ef">continue</span>;
        }
        <span style="color:#66d9ef">if</span> (rlen <span style="color:#f92672">!=</span> write(s, req, rlen)) {
            failed<span style="color:#f92672">++</span>;
            close(s);
            <span style="color:#66d9ef">continue</span>;
        }
        <span style="color:#66d9ef">if</span> (http10 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
            <span style="color:#66d9ef">if</span> (shutdown(s, <span style="color:#ae81ff">1</span>)) {
                failed<span style="color:#f92672">++</span>;
                close(s);
                <span style="color:#66d9ef">continue</span>;
            }
        <span style="color:#66d9ef">if</span> (force <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#75715e">/* read all available data from socket */</span>
            <span style="color:#75715e">/* 读取服务器响应 */</span>
            <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
                <span style="color:#66d9ef">if</span> (timerexpired) <span style="color:#66d9ef">break</span>;
                i <span style="color:#f92672">=</span> read(s, buf, <span style="color:#ae81ff">1500</span>);
                <span style="color:#75715e">/* fprintf(stderr,&#34;%d\n&#34;,i); */</span>
                <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
                    failed<span style="color:#f92672">++</span>;
                    close(s);
                    <span style="color:#66d9ef">goto</span> nexttry;
                } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
                    <span style="color:#66d9ef">break</span>;
                <span style="color:#66d9ef">else</span>
                    bytes <span style="color:#f92672">+=</span> i;
            }
        }
        <span style="color:#66d9ef">if</span> (close(s)) {
            failed<span style="color:#f92672">++</span>;
            <span style="color:#66d9ef">continue</span>;
        }
        speed<span style="color:#f92672">++</span>;
    }
}</code></pre></div></article>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

  <div class="footer container-lg width-full p-responsive" role="contentinfo">
    <div
        class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
        <ul
            class="list-style-none d-flex flex-wrap col-12 col-lg-5 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
            <li class="mr-3 mr-lg-0">© 2019. Theme by <a href="https://github.com/MeiK2333/github-style"><span>github-style</span></a></li>
        </ul>

        <a aria-label="Homepage" title="MeiK&#39;s blog" class="footer-octicon d-none d-lg-block mx-lg-4"
            href="https://meik2333.com/">
            <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24"
                aria-hidden="true">
                <path fill-rule="evenodd"
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                </path>
            </svg>
        </a>
        <ul
            class="list-style-none d-flex flex-wrap col-12 col-lg-5 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
        </ul>
    </div>
    <div class="d-flex flex-justify-center pb-6">
        <span class="f6 text-gray-light"></span>
    </div>
</div>

<script crossorigin="anonymous"
    integrity="sha512-P7QbxhTkfogU8wuMH3u9CEiNA9esk13jExiHBnpW+Kh9fKban2yNVEok9xzV2GqSuEU3ZbCKe0GooUfc6szm4g=="
    type="application/javascript" src="https://github.githubassets.com/assets/frameworks-e0eb4964.js"></script>

<script crossorigin="anonymous" async="async"
    integrity="sha512-UjV5G8yJkGcA9OW3TPPQx+Rk3uyOfOVmYEWLj7ADv81bEy8Jp9oDULYFdQxOxJq518DFlt0+dBqobwvarLrNgA=="
    type="application/javascript" src="https://github.githubassets.com/assets/github-bootstrap-35e32afb.js"></script>
<script>
    let classs = ['pinned-item-desc', 'text-gray', 'text-small', 'd-block', 'mt-2', 'mb-3'];
    const pinned_posts = document.getElementsByName('pinned-post');
    for (let i = 0; i < pinned_posts.length; i++) {
        for (let j = 0; j < classs.length; j++) {
            pinned_posts[i].getElementsByTagName('p')[0].classList.add(classs[j]);
        }
    }
    classs = [ 'd-inline-block', 'text-gray', 'mb-2', 'pr-4'];
    const posts_posts = document.getElementsByName('posts-post');
    for (let i = 0; i < posts_posts.length; i++) {
        for (let j = 0; j < classs.length; j++) {
            posts_posts[i].getElementsByTagName('p')[0].classList.add(classs[j]);
        }
    }
</script>
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-107784973-4', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>